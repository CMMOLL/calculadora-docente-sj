<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Liquidación de Sueldos</title>
  <link rel="icon" href="images/favicon-32x32.png" type="image/png" />
  <link id="app-css" rel="stylesheet" href="css/styles.css">
</head>

<script>
(async () => {
  const cssPath = "css/styles.css";
  let version = "";

  try {
    // Pedimos SOLO cabeceras para obtener ETag / Last-Modified
    const res = await fetch(cssPath, { method: "HEAD", cache: "no-store" });
    version =
      (res.headers.get("etag") || res.headers.get("last-modified") || "").replace(/"/g,"");
  } catch (e) {
    // Fallback: timestamp (por si algo raro impide leer cabeceras)
    version = String(Date.now());
  }

  // Guardamos la versión para reutilizar en otros assets (JSON, imágenes, etc.)
  window.__assetVersion = version || String(Date.now());

  // Actualizamos el href del <link> para forzar recarga si cambió el contenido
  const link = document.getElementById("app-css");
  if (link) {
    const url = new URL(link.getAttribute("href"), location.href);
    url.searchParams.set("v", window.__assetVersion);
    // Sólo reasignamos si cambió para evitar recargas innecesarias
    if (link.href !== url.href) link.href = url.pathname + "?" + url.searchParams.toString();
  }
})();
</script>

<script src="js/codigos.js"></script>
<script src="js/codigos/e66.js"></script>

<script>
  function prevYMLocal(ym){
    const [y, m] = String(ym || "").split('-').map(Number);
    if (!y || !m) return "";
    const d = new Date(y, m - 1, 1);
    d.setMonth(d.getMonth() - 1);
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2,'0')}`;
  }
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const selMes   = document.getElementById('indicePeriodo');
    const selTipo  = document.getElementById('tipoSeleccion');
    const horasInp = document.getElementById('horasValor');

    function save(){
      const data = {
        ym: selMes?.value || '',
        tipo: selTipo?.value || '',
        horas: horasInp?.value || ''
      };
      try { localStorage.setItem('liq_prefs', JSON.stringify(data)); } catch (e) {}
    }

    function load(){
      try {
        const raw = localStorage.getItem('liq_prefs');
        if (!raw) return;
        const d = JSON.parse(raw) || {};
        if (selMes && d.ym) selMes.value = d.ym;
        if (selTipo && d.tipo) selTipo.value = d.tipo;
        if (horasInp) horasInp.value = d.horas ?? '';
      } catch (e) {}
    }

    const triggerUpdate = () => {
      if (typeof update === 'function') {
        try { update(); } catch (e) {}
      }
    };

    load();

    selMes?.addEventListener('change', () => { save(); triggerUpdate(); });
    selTipo?.addEventListener('change', () => { save(); triggerUpdate(); });
    horasInp?.addEventListener('input', () => { save(); triggerUpdate(); });

    if (selTipo) selTipo.dispatchEvent(new Event('change'));
    if (selMes) selMes.dispatchEvent(new Event('change'));
    triggerUpdate();
  });
</script>
<body>
  <div class="card">
    <h1>Liquidación de Sueldos</h1>
    <div class="grid-2">
      <div class="leftCol">
        <div class="sidebar">
          <!-- === Nuevo bloque: Seleccionar Cargos/Horas Cátedra === -->
          <div id="cargoHorasBlock" class="result">
            <label class="title" style="display:block;margin-bottom:8px;">Seleccionar Cargos/Horas Cátedra</label>

            <!-- Lista desplegable principal -->
            <!-- (REMOVIDO) <label class="muted">Lista desplegable</label> -->
            <select id="tipoSeleccion">
              <option value="" selected disabled>— Seleccionar —</option>
              <option value="CARGOS">Cargos</option>
              <option value="HCNM">Horas Cátedra Nivel Medio</option>
              <option value="HCNS">Horas Cátedra Nivel Superior</option>
            </select>

            <!-- Panel CARGOS: ingresar categoría/ID -->
            <div id="panelCargos" style="display:none; margin-top:10px;">
              <label class="muted">Cargos</label>
              <input
                id="catId"
                type="text"
                placeholder="Categoría o nombre"
                autocomplete="off"
                spellcheck="false"
                style="width:22ch;"
              />
              <!-- (REMOVIDO) <div class="muted" style="margin-top:6px;">Ej.: 55, 28, 167…</div> -->
              <!-- Denominación del cargo (se muestra solo si hay ID válido) -->
           <div id="cargoNombreWrap" class="muted" style="margin-top:6px; display:none;">
  <span>Denominación:</span>
  <span class="title" id="cargoNombre">—</span>
  <span id="multBadge" style="display:none; margin-left:8px; padding:2px 6px; border-radius:10px; border:1px solid #d6d6e7;">
    x1
  </span>
</div>

            </div>
            <!-- NUEVO: Card grande para Horas Cátedra (HCNM/HCNS) -->
            <div id="horasCard" style="display:none; margin-top:12px;">
              <div class="horas-card">
                <label for="horasValor" class="horas-title">Horas Cátedra</label>
                <input
                  id="horasValor"
                  type="number"
                  min="0"
                  max="99"
                  step="1"
                  inputmode="numeric"
                  placeholder="por ej. 3"
                  aria-label="Cantidad de horas cátedra"
                />
              </div>
            </div>
          </div>
          <!-- === Cálculo de Días de Licencias – Cartas Médicas === -->
<div id="licenciasCard" class="result" style="margin-top:10px;">
  <div class="title">Cálculo de Días de Licencias – Cartas Médicas</div>
  <div class="row" style="gap:12px; align-items:flex-end; flex-wrap:wrap;">
    <label class="muted">Fecha de inicio
      <input id="licInicio" type="date" />
    </label>

    <label class="muted">Días de licencia
      <input id="licDias" type="number" min="0" step="1" style="width:8ch;" />
    </label>

    <label class="muted">Fecha de finalización
      <input id="licFin" type="text" class="num-display" readonly />
    </label>
  </div>
</div>

        </div>
        <div class="stack">

          <div id="fechasRow" class="row" style="align-items:flex-end; gap:16px; flex-wrap:wrap;">
            <div class="date-field">
              <label for="inicio">Fecha Inicio</label>
              <input id="inicio" placeholder="dd/mm/aaaa" type="date" />
            </div>

            <div class="date-field">
              <label for="fin">Fecha Fin</label>
              <input id="fin" placeholder="dd/mm/aaaa" type="date" />
            </div>

            <!-- BAJA: checkbox primero y texto a la derecha -->
            <label id="bajaGroup" for="baja" class="muted" style="display:inline-flex;align-items:center;gap:8px;">
              <input id="baja" type="checkbox" />
              <span>Baja</span>
            </label>
          </div>
        </div>
        <div class="result" id="liqBlock">
          <div class="title">Liquidación</div>

<div class="row" id="indicesRow" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
  <label class="muted" style="position:relative; display:inline-flex; align-items:center; gap:8px;">
    Índice del mes
    <input id="indiceMes" step="0.0001" class="num-display" type="number" value="787.1022" readonly />
    <select id="indicePeriodo" aria-label="Mes y año del índice"></select>
  </label>

  <div id="indicePrevToolbar" style="display:none;">
    <label class="muted">
      Índice mes anterior
      <input id="indiceMesPrev_clone" name="indiceMesPrev_clone" step="0.0001" class="num-display" type="number" value="772.4261" readonly />
    </label>
  </div>
</div>



<!-- Código viejo (eliminar si funciona el cambio)
          <div id="indicesRow"
            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;"><label
              class="muted">Índice del mes
              <input id="indiceMes" step="0.0001" style="width:auto-size"; margin-left:6px;" type="number" value="787.1022" />
              <select id="indicePeriodo" aria-label="Mes y año del índice"></select>
            </label>
            <div id="indicePrevToolbar" style="display:none;"><label class="muted">Índice mes anterior
                <input id="indiceMesPrev_clone" name="indiceMesPrev_clone" step="0.0001" style="width:auto-size;"
                  type="number" value="772.4261" />
              </label></div>
          </div>
-->
          <div class="row"
            style="display:flex; flex-direction:column; align-items:flex-start; gap:6px; margin:8px 0 4px 0;"><label
              class="muted">Antigüedad (años)
              <input id="antiguedadAnios" min="0" step="1" type="number"
                value="0" /> <span class="pill" id="antiguedadPct" style="margin-left:8px;">0%</span>
              <label class="muted">Radio
                <select id="radioDocente" style="margin-left:6px;">
                  <option value="0">Sin radio</option>
                  <option value="40">Radio 1 (40%)</option>
                  <option value="50">Radio 2 (50%)</option>
                  <option value="60">Radio 3 (60%)</option>
                  <option value="90">Radio 4 (90%)</option>
                  <option value="110">Radio 5 (110%)</option>
                  <option value="130">Radio 6 (130%)</option>
                  <option value="150">Radio 7 (150%)</option>
                </select>
              </label>
              <div id="optExtras" class="muted">
                <span class="label">Extras:</span>

                <label title="Estado Docente">A56
                  <input id="optA56" type="checkbox">
                </label>

                <label title="Suma Remun. y bonificable por antigüedad">E66
                  <input id="optE66" type="checkbox">
                </label>

                <label title="Suma Remun. y bonificable por antigüedad (solo cargos)">E60
                  <input id="optE60" type="checkbox">
                </label>

                <label title="Suplente">Suplente
                  <input id="suplente" type="checkbox">
                </label>
              </div>

              <label class="muted" style="display:none;">Índice mes anterior
                <input id="indiceMesPrev" step="0.0001" style="width:12ch; margin-left:6px;" type="number"
                  value="772.4261" />
              </label>
          </div>
          <span class="pill"><b id="diasLiq">0</b></span>
          <div class="liq-columns">
            <div>
              <table class="tabla-codigos">
                <thead>
                  <tr>
                    <th>Código</th>
                    <th></th>
                    <th>Importe</th>
                  </tr>
                </thead>
                <tbody id="liqBaseBody">
                  <tr>
                    <td><b>A01</b> Sueldo Básico</td>
                    <td>$</td>
                    <td id="a01Importe">0,00</td>
                  </tr>
                  <tr>
                    <td><b>A03</b> Antigüedad</td>
                    <td>$</td>
                    <td id="a03Importe">0,00</td>
                  </tr>
                  <tr>
                    <td><b>A04</b> Radio</td>
                    <td>$</td>
                    <td id="a04Importe">0,00</td>
                  </tr>
                  <tr id="rowA56" style="display:none;">
                    <td title="Estado Docente"><b>A56</b></td>
                    <td>$</td>
                    <td id="a56Importe">0,00</td>
                  </tr>
                  <tr id="rowE29" style="display:none;">
                    <td title="Equipamiento Suplentes"><b>E29</b></td>
                    <td>$</td>
                    <td id="e29Importe">0,00</td>
                  </tr>
                  <tr id="rowE66" data-codigo="E66" style="display:none;">
                    <td title="Suma Remunerativa y bonificable por antigüedad"><b>E66</b></td>
                    <td>$</td>
                    <td><span id="e66Importe">0,00</span></td>
                  </tr>
                  <tr id="rowE60" data-codigo="E60" style="display:none;">
                    <td title="Suma Remunerativa y bonificable por antigüedad (solo cargos)"><b>E60</b></td>
                    <td>$</td>
                    <td><span id="e60Importe">0,00</span></td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <td><b>Total Parcial</b></td>
                    <td>$</td>
                    <td id="totalParcial">0,00</td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div id="complementoBox" style="display:none;; position:relative;">
            <div class="muted" style="margin:6px 0 4px 0;" title="F = Complemento (días excedentes)">Complemento</div>
              <div class="pill" style="margin:0 0 6px 0;">Días excedentes: <b id="diasExc">0</b></div>
              <table class="tabla-codigos">
                <thead>
                  <tr>
                    <th>Código</th>
                    <th></th>
                    <th>Importe</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><b>A01</b> Sueldo Básico</td>
                    <td>$</td>
                    <td id="a01Exc">0,00</td>
                  </tr>
                  <tr>
                    <td><b>A03</b> Antigüedad</td>
                    <td>$</td>
                    <td id="a03Exc">0,00</td>
                  </tr>
                  <tr>
                  <tr>
                    <td><b>A04</b> Radio</td>
                    <td>$</td>
                    <td id="a04Exc">0,00</td>
                  </tr>
                  <!-- NUEVO: F56 para complemento de A56 -->
                  <tr id="rowF56" style="display:none;">
                    <td title="Complemento del codigo A56 (mes anterior)"><b>F56</b></td>
                    <td>$</td>
                    <td id="f56Importe">0,00</td>
                  </tr>

                  <!-- NUEVO: E29 también se muestra en complemento (mismo código) -->
                  <tr id="rowE29_comp" style="display:none;">
                    <td title="Equipamiento Suplentes (en complemento)"><b>E29</b></td>
                    <td>$</td>
                    <td id="e29CompImporte">0,00</td>
                  </tr>
                  <tr id="rowF66" style="display:none;">
                    <td title="Complemento del código E66 (mes anterior)"><b>F66</b></td>
                    <td>$</td>
                    <td id="f66Importe">0,00</td>
                  </tr>
                  <tr id="rowF60" style="display:none;">
                    <td title="Complemento del código E60 (mes anterior)"><b>F60</b></td>
                    <td>$</td>
                    <td id="f60Importe">0,00</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="muted" style="margin-top:6px;">
            * Si el período supera 30 días: se calculan 30 d con el índice vigente y el excedente con el índice del mes
            anterior.
          </div>
          <div class="muted" style="margin-top:6px;">Criterio: inicio siempre incluido · fin <span id="finLabel2">NO
              incluido</span>.</div>
        </div>
      </div>
      <aside class="rightCol">
        <div class="months-box">
          <div class="months-header">
            <div class="title" style="; margin-left:40px;">Desglose Mensual (30/360)</div>
            <div class="pill" id="periodoLabel">—</div>
          </div>
          <div class="result">
            <table>
              <thead>
                <tr>
                  <th>Mes</th>
                  <th>Días</th>
                </tr>
              </thead>
              <tbody id="tbodyMeses">
                <tr>
                  <td class="muted" colspan="2">Ingresá inicio y fin…</td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td>Total</td>
                  <td id="totalDias">—</td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div class="result">
            <div class="row" style="justify-content:space-between;">
              <div class="title" style="; margin-left:40px;">Días de Aguinaldo</div>
              <div class="row">
                <label class="muted">Año
                  <select id="anioSAC"></select>
                </label>
                <label class="muted">Semestre
                  <select id="semSAC">
                    <option value="1">1º SAC (Ene–Jun)</option>
                    <option value="2">2º SAC (Jul–Dic)</option>
                  </select>
                </label>
              </div>
            </div>
            <div style="margin-top:8px;">
              <span class="muted">Días dentro del semestre seleccionado:</span>
              <span class="title" id="diasSAC">—</span>
            </div>
          </div>
          <div class="result" id="decimasBlock" style="display:none;">
            <div class="title">Décimas</div>
            <div class="muted">(Comprende del 1 Mar al 30 Dic)</div>
            <div style="margin-top:8px;">
              <span class="muted">Total:</span>
              <span class="title" id="decimasTotal">—</span>
            </div>
            <div class="muted" id="decimasDetalle" style="margin-top:6px;">—</div>
          </div>
        </div>
    </div>
    </aside>
  </div>
  </div>
 <!-- === Loader Nomenclador + Índices === -->
<script>
(function(){
  const NOMEN_URLS  = [
    'data/cargos/nomenclador_agosto_2024.json',
    'docs/data/cargos/nomenclador_agosto_2024.json'
  ];
  const INDICES_URLS = [
    'data/indices.json',
    'docs/data/indices.json'
  ];

  async function fetchFirst(urls){
    for (const u of urls){
      try { const r = await fetch(u, {cache:'no-store'}); if (r.ok) return await r.json(); } catch(e){}
    }
    throw new Error('No se pudo cargar: ' + urls.join(' | '));
  }

  let _cargos = null;      // array de cargos
  let _indices = null;     // { 'YYYY-MM': number }
  let _baseline = '2024-08';

  async function ensure(){
    if (_cargos && _indices) return;
    const [nomen, idx] = await Promise.all([
      fetchFirst(NOMEN_URLS),
      fetchFirst(INDICES_URLS)
    ]);
    _cargos = (nomen.cargos || []).map(c => ({...c, A32: c.A32 ?? 0, A44: c.A44 ?? 0}));
    _baseline = nomen.baselineMonth || _baseline;
    _indices = idx.indices || idx; // soporta ambos formatos
  }

  function getByCategoria(cat){
    if (!_cargos) return null;
    return _cargos.find(c => Number(c.categoria) === Number(cat)) || null;
  }
  function search(text){
    if (!_cargos || !Array.isArray(_cargos)) return [];
    const q = String(text || "").trim().toLowerCase();
    if (!q) return [];
    const isNum = /^\d+$/.test(q);
    let results = [];
    if (isNum) {
      results = _cargos.filter(c => String(c.categoria || "").startsWith(q));
    } else {
      results = _cargos.filter(c => String(c.denominacion || "").toLowerCase().includes(q));
    }
    results.sort((a, b) => {
      const qa = String(a.categoria), qb = String(b.categoria);
      const dnA = String(a.denominacion || "").toLowerCase();
      const dnB = String(b.denominacion || "").toLowerCase();
      const exactA = (isNum && qa === q) || (!isNum && dnA === q);
      const exactB = (isNum && qb === q) || (!isNum && dnB === q);
      if (exactA && !exactB) return -1;
      if (!exactA && exactB) return 1;
      const startsA = isNum ? qa.startsWith(q) : dnA.startsWith(q);
      const startsB = isNum ? qb.startsWith(q) : dnB.startsWith(q);
      if (startsA && !startsB) return -1;
      if (!startsA && startsB) return 1;
      if (dnA < dnB) return -1;
      if (dnA > dnB) return 1;
      return Number(a.categoria) - Number(b.categoria);
    });
    return results.slice(0, 10);
  }
  function getIndice(ym){ return Number(_indices?.[ym] || 0); }

  // Para el futuro (si hubiera doble incremento por categoría)
  function aplicarDoubleIncrement(montoBase, indiceBaseline, indiceActual, enabled){
    const base = Number(montoBase || 0);
    const ib = Number(indiceBaseline || 1), ia = Number(indiceActual || ib);
    if (!enabled || ib <= 0) return base;
    const variacion = (ia/ib) - 1;
    return base * (1 + variacion * 2);
  }

  window.CARGOS = {
    ready: async () => { await ensure(); return true; },
    getByCategoria,
    getIndice,
    getBaselineMonth: () => _baseline,
    aplicarDoubleIncrement,
    search
  };

  // precarga para no demorar la primera consulta
  window.CARGOS.ready().then(() => { if (typeof update === 'function') { try { const maybe = update(); if (maybe && typeof maybe.catch === 'function') { maybe.catch(err => console.warn('update error:', err)); } } catch(e){} } });
})();
</script>
<script>


/* Selector Mes-Año con <select> nativo, 6 visibles sin reflow + excepción de mes actual faltante */
(function () {
  const MES_ABR = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  const INDICES_URL = 'data/indices.json';

  const selPeriodo  = document.getElementById('indicePeriodo'); // <select>
  const indiceInput = document.getElementById('indiceMes');     // visible (readonly)
  const prevCalc    = document.getElementById('indiceMesPrev'); // oculto (cálculo)

  if (!selPeriodo || !indiceInput || !prevCalc) return;

  const now   = new Date();
  const curYM = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

  const toFixed4 = n => {
    const x = Number(n);
    return Number.isFinite(x) ? x.toFixed(4) : '';
  };
  const labelDeClave = ym => {
    const [y, m] = ym.split('-').map(Number);
    return `${MES_ABR[m-1]}-${y}`;
  };
  const prevYM = k => {
    let [y, m] = k.split('-').map(Number);
    m -= 1; if (m === 0) { y -= 1; m = 12; }
    return `${y}-${String(m).padStart(2,'0')}`;
  };

  let mapa = {};
  let claves = [];
  let latest = null;

  function aplicarPeriodo(k) {
    if (!k || !mapa[k]) return Promise.resolve(false);
    const v = Number(mapa[k]);
    indiceInput.value = toFixed4(v);
    // Excepción: si el mes calendario no existe y estamos en el último disponible,
    // "Índice mes anterior" = mismo valor
    const hasCurrent = mapa[curYM] != null;
    let prevValue;
    if (!hasCurrent && k === latest) {
      prevValue = v;
    } else {
      const kp = prevYM(k);
      prevValue = Number(mapa[kp]);
    }
    prevCalc.value = toFixed4(prevValue);
    const prevClone = document.getElementById('indiceMesPrev_clone');
    if (prevClone) prevClone.value = toFixed4(prevValue);

    const runRecalc = () => {
      indiceInput.dispatchEvent(new Event('input', { bubbles:true }));
      prevCalc.dispatchEvent(new Event('input', { bubbles:true }));
      if (typeof update === 'function') { try { update(); } catch {} }
    };

    const ensure = window.CODIGOS?.E66?.ensureLoaded(k);
    if (ensure && typeof ensure.then === 'function') {
      return ensure.then(() => { runRecalc(); return true; });
    }
    runRecalc();
    return Promise.resolve(true);
  }

  async function init() {
    try {
      const v = window.__assetVersion ? `?v=${window.__assetVersion}` : '';
      const res = await fetch(INDICES_URL + v, { cache: 'no-store' });
      const json = await res.json();
      mapa = json.indices || json;
    } catch (e) {
      console.warn('No se pudo cargar data/indices.json', e);
      selPeriodo.innerHTML = ''; indiceInput.value = ''; prevCalc.value = '';
      return;
    }

    // Construir opciones (todas, orden desc)
    claves = Object.keys(mapa)
      .filter(k => /^\d{4}-\d{2}$/.test(k))
      .sort()
      .reverse();

    selPeriodo.innerHTML = '';
    for (const k of claves) {
      const opt = document.createElement('option');
      opt.value = k;
      opt.textContent = labelDeClave(k);
      selPeriodo.appendChild(opt);
    }

    latest = claves[0] || null;

    // Selección inicial: último disponible
    if (latest) {
      selPeriodo.value = latest;
      const resInit = aplicarPeriodo(selPeriodo.value);
      if (resInit && typeof resInit.then === 'function') {
        resInit.catch(() => {});
      } else {
        window.CODIGOS?.E66?.ensureLoaded(selPeriodo.value).then(() => {
          if (typeof update === 'function') { try { update(); } catch {} }
        });
      }

    }
    // Cambio de período
    selPeriodo.addEventListener('change', () => {
      const clave = selPeriodo.value;
      const res = aplicarPeriodo(clave);
      if (res && typeof res.then === 'function') {
        res.catch(() => {});
        return;
      }
      window.CODIGOS?.E66?.ensureLoaded(clave).then(() => {
        if (typeof update === 'function') { try { update(); } catch {} }
      });
    });

  }

  if (document.readyState !== 'loading') init();
  else document.addEventListener('DOMContentLoaded', init);
})();






    // ===== Utilidades
    function toUTCDate(y, m, d) { return new Date(Date.UTC(y, m, d)); }
    function parseDate(s) { if (!s) return null; const [y, m, d] = s.split('-').map(Number); if (!y || !m || !d) return null; return toUTCDate(y, m - 1, d); }
    function is31MonthNum(m) { return [1, 3, 5, 7, 8, 10, 12].includes(m); }
    function monthNameEs(m) { return ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'][m - 1]; }
    function addMonth(y, m) { return (m === 12) ? { y: y + 1, m: 1 } : { y, m: m + 1 }; }
    function fmtDMY(d) { const y = d.getUTCFullYear(), m = String(d.getUTCMonth() + 1).padStart(2, '0'), da = String(d.getUTCDate()).padStart(2, '0'); return `${da}/${m}/${y}`; }
    function fmtAR(n) { return n.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    // Ajusta el ancho de un <select> al de su opción más larga
    function adjustSelectWidth(sel) {
      if (!sel) return;
      const comp = getComputedStyle(sel);
      const test = document.createElement('span');
      test.style.visibility = 'hidden'; test.style.whiteSpace = 'pre'; test.style.position = 'absolute'; test.style.font = comp.font; test.style.letterSpacing = comp.letterSpacing;
      document.body.appendChild(test);
      let max = 0;
      for (const opt of sel.options) { test.textContent = opt.text; const w = test.offsetWidth; if (w > max) max = w; }
      document.body.removeChild(test);
      const paddings = parseFloat(comp.paddingLeft) + parseFloat(comp.paddingRight);
      const extra = paddings + 36;
      sel.style.width = Math.ceil(max + extra) + 'px';
    }

    // ===== Cálculo 30/360
    function breakdown30_360(start, end, baja) {
      let y1 = start.getUTCFullYear(), m1 = start.getUTCMonth() + 1, d1 = start.getUTCDate();
      let y2 = end.getUTCFullYear(), m2 = end.getUTCMonth() + 1, d2 = end.getUTCDate();
      const s = Math.min(d1, 30), e = Math.min(d2, 30);
      const rows = [];
      if (y1 === y2 && m1 === m2) {
        let eEff; if (baja) { eEff = (d2 === 31 && is31MonthNum(m2)) ? 30 : e - 1; } else { eEff = e; }
        let days = eEff - s + 1; if (days < 1) days = 1; rows.push({ y: y1, m: m1, days }); return rows;
      }
      const daysFirst = 30 - s + 1; rows.push({ y: y1, m: m1, days: daysFirst });
      let yc = y1, mc = m1; while (true) { const nm = addMonth(yc, mc); yc = nm.y; mc = nm.m; if (yc === y2 && mc === m2) break; rows.push({ y: yc, m: mc, days: 30 }); }
      let last; if (baja) { last = (d2 === 31 && is31MonthNum(m2)) ? 30 : Math.max(0, e - 1); } else { last = e; } rows.push({ y: y2, m: m2, days: last });
      return rows;
    }

    // ===== Lógica de la interfaz y cálculos
    const ANTIG_Tabla = [{ y: 34, p: 170 }, { y: 32, p: 160 }, { y: 30, p: 150 }, { y: 28, p: 140 }, { y: 25, p: 130 }, { y: 24, p: 120 }, { y: 22, p: 110 }, { y: 20, p: 100 }, { y: 17, p: 80 }, { y: 15, p: 70 }, { y: 12, p: 60 }, { y: 10, p: 50 }, { y: 7, p: 40 }, { y: 5, p: 30 }, { y: 2, p: 15 }, { y: 1, p: 10 }, { y: 0, p: 0 }];
    function getAntiguedad(anios) { const item = ANTIG_Tabla.find(a => anios >= a.y); return item ? item.p : 0; }
    function uiUpdateAntigPct() {
      var el = document.getElementById('antiguedadPct');
      if (!el) return; var anios = parseInt(document.getElementById('antiguedadAnios').value || '0');
      var p = getAntiguedad(anios); el.textContent = p.toFixed(0) + '%';
    }
        function isHoras() {
      const t = (typeof getTipoCargo === 'function') ? getTipoCargo() : '';
      return t === 'HCNM' || t === 'HCNS';
    }
    function isMaestroGradoJornadaCompleta(cargo) { return cargo === "Maestro de Grado - Jornada Completa"; }

    const inputInicio = document.getElementById('inicio');
    const inputFin = document.getElementById('fin');
    const liqBlock = document.getElementById('liqBlock');
    const inputSuplente = document.getElementById('suplente');
    const inputBaja = document.getElementById('baja');
    const complementoBox = document.getElementById('complementoBox');

    const liqDato = {
      diasLiq: document.getElementById('diasLiq'),
      a01: document.getElementById('a01Importe'),
      a03: document.getElementById('a03Importe'),
      a04: document.getElementById('a04Importe'),
      totalParcial: document.getElementById('totalParcial'),
      diasExc: document.getElementById('diasExc'),
      a01Exc: document.getElementById('a01Exc'),
      a03Exc: document.getElementById('a03Exc'),
      a04Exc: document.getElementById('a04Exc')
    };
    const inputIndiceMes = document.getElementById('indiceMes');
    const inputIndiceMesPrev = document.getElementById('indiceMesPrev');
    const inputAntiguedad = document.getElementById('antiguedadAnios');
    const selectRadio = document.getElementById('radioDocente');
    const tbodyMeses = document.getElementById('tbodyMeses');
    const totalDias = document.getElementById('totalDias');
    const periodoLabel = document.getElementById('periodoLabel');
    const selectAnioSAC = document.getElementById('anioSAC');
    const selectSemSAC = document.getElementById('semSAC');
    const diasSAC = document.getElementById('diasSAC');
    const decimasBlock = document.getElementById('decimasBlock');
    const decimasTotal = document.getElementById('decimasTotal');
    const decimasDetalle = document.getElementById('decimasDetalle');
    const finLabel2 = document.getElementById('finLabel2');

    // Inicializar años para SAC
    const currentYear = new Date().getFullYear();
    for (let i = currentYear - 5; i <= currentYear + 1; i++) {
      const opt = document.createElement('option');
      opt.value = i; opt.textContent = i;
      selectAnioSAC.appendChild(opt);
    }
    selectAnioSAC.value = currentYear;

    function renderDesglose(rows) {
      tbodyMeses.innerHTML = '';
      if (rows.length === 0) {
        tbodyMeses.innerHTML = '<tr><td class="muted" colspan="2">Ingresá inicio y fin…</td></tr>';
        totalDias.textContent = '0';
        return;
      }
      let total = 0;
      rows.forEach(r => {
        const tr = document.createElement('tr');
        const td1 = document.createElement('td');
        const td2 = document.createElement('td');
        td1.textContent = `${monthNameEs(r.m)} ${r.y}`;
        td2.textContent = r.days;
        tr.appendChild(td1);
        tr.appendChild(td2);
        tbodyMeses.appendChild(tr);
        total += r.days;
      });
      totalDias.textContent = total;
    }

    function calcularSAC(rows, anio, sem) {
      let dias = 0;
      const startMonth = (sem === 1) ? 1 : 7;
      const endMonth = (sem === 1) ? 6 : 12;
      rows.forEach(r => {
        if (r.y === anio && r.m >= startMonth && r.m <= endMonth) {
          dias += r.days;
        }
      });
      return dias;
    }

    function calcularDecimas(rows) {
      let diasTotal = 0;
      const detalle = [];
      const startMonth = 3, endMonth = 12; // Marzo a Diciembre
      rows.forEach(r => {
        if (r.m >= startMonth && r.m <= endMonth) {
          diasTotal += r.days;
          detalle.push(`${monthNameEs(r.m)} ${r.y}: ${r.days} días`);
        }
      });
      return { total: diasTotal, detalle: detalle.join(' · ') };
    }

                async function calculateLiq(start, end, baja) {
      if (!start || !end) {
        liqDato.diasLiq.textContent = '0';
        liqBlock.style.display = 'none';
        complementoBox.style.display = 'none';
        return;
      }
      liqBlock.style.display = 'block';
      const tipoSel = (typeof getTipoCargo === 'function') ? (getTipoCargo() || '') : '';
      const esHoras = (tipoSel === 'HCNM' || tipoSel === 'HCNS');
      const horasSeleccionadas = esHoras ? Number((typeof getHorasSeleccionadas === 'function' ? getHorasSeleccionadas() : 0) || 0) : 0;
      const categoriaId = esHoras ? 0 : Number((typeof getCategoriaId === 'function' ? getCategoriaId() : 0) || 0);
      const __cargoNombreWrap = document.getElementById('cargoNombreWrap');
      const __cargoNombre = document.getElementById('cargoNombre');
      function __setCargoNombre(txt) {
        if (!__cargoNombreWrap || !__cargoNombre) return;
        if (txt && String(txt).trim()) {
          __cargoNombre.textContent = txt;
          __cargoNombreWrap.style.display = 'block';
        } else {
          __cargoNombre.textContent = '-';
          __cargoNombreWrap.style.display = 'none';
        }
      }
      const indiceActual = parseFloat(inputIndiceMes.value) || 0;
      const indicePrevio = parseFloat(inputIndiceMesPrev.value) || 0;
      const antiguedadAnios = parseFloat(inputAntiguedad.value) || 0;
      const radioPorcentaje = parseFloat(selectRadio.value) || 0;
      const antiguedadPts = getAntiguedad(antiguedadAnios);
      const rowsCalc = breakdown30_360(start, end, baja);
      let totalDays = 0; rowsCalc.forEach(r => totalDays += r.days);
      let diasBase = Math.min(30, totalDays);
      let diasExc = Math.max(0, totalDays - 30);
      complementoBox.style.display = (diasExc > 0) ? 'block' : 'none';
      const mesBaseName = monthNameEs(end.getUTCMonth() + 1);
      liqDato.diasLiq.textContent = `${diasBase} Días - ${mesBaseName} ${end.getUTCFullYear()}`;
      liqDato.diasExc.textContent = diasExc;
      let totalParcial = 0;
      let a01 = 0;
      let a03 = 0;
      let a04 = 0;
      let a01Exc = 0;
      let a03Exc = 0;
      let a04Exc = 0;
      let sueldoBasico = 0;
      let sueldoBasicoExc = 0;
      const periodoSelect = document.getElementById('indicePeriodo');
      const ymSeleccionado = (periodoSelect?.value || '').trim();
      const ymPrevSeleccionado = ymSeleccionado
        ? (window.PUNTOS?.prevYM?.(ymSeleccionado) || prevYMLocal(ymSeleccionado))
        : '';

      // ===== Integración Nomenclador / Horas (A01/A32/A44) =====
      {
        if (typeof window.__ensureA32A44Rows === 'function') window.__ensureA32A44Rows();
        (function resetA3244() {
          const r32 = document.getElementById('rowA32'), r44 = document.getElementById('rowA44');
          const c32 = document.getElementById('a32Importe'), c44 = document.getElementById('a44Importe');
          if (r32) r32.style.display = 'none';
          if (r44) r44.style.display = 'none';
          if (c32) c32.textContent = '0,00';
          if (c44) c44.textContent = '0,00';
        })();

        const diasBaseNum = Number(diasBase || 0);
        const diasExcNum = Number(diasExc || 0);

        if (esHoras) {
          __setCargoNombre(null);
          const horasValidas = Math.max(0, Math.floor(Number(horasSeleccionadas || 0)));
          const nivel = (tipoSel === 'HCNS') ? 'HCNS' : 'HCNM';
          const hcModule = window.CODIGOS?.HC;
          const importeBase = hcModule?.getImporteBase?.({ ym: ymSeleccionado, dias: diasBaseNum, horas: horasValidas, nivel }) || 0;
          const importeBaseMensual = hcModule?.getImporteBase?.({ ym: ymSeleccionado, dias: 30, horas: horasValidas, nivel }) || 0;
          const importeComplemento = diasExcNum > 0
            ? (hcModule?.getImporteComplemento?.({ ym: ymSeleccionado, ymPrev: ymPrevSeleccionado, dias: diasExcNum, horas: horasValidas, nivel }) || 0)
            : 0;
          const importeComplementoMensual = diasExcNum > 0
            ? (hcModule?.getImporteComplemento?.({ ym: ymSeleccionado, ymPrev: ymPrevSeleccionado, dias: 30, horas: horasValidas, nivel }) || 0)
            : 0;

          a01 = importeBase;
          a01Exc = importeComplemento;
          sueldoBasico = importeBaseMensual;
          sueldoBasicoExc = importeComplementoMensual;

          const a01Cell = document.getElementById('a01Importe'); if (a01Cell) a01Cell.textContent = fmtAR(a01);
          const a01ExcCell = document.getElementById('a01Exc'); if (a01ExcCell) a01ExcCell.textContent = fmtAR(a01Exc);
        } else {
          try {
            await (window.CARGOS?.ready?.());
          } catch (err) {
            console.warn('CARGOS ready error:', err);
          }
          const cargo = window.CARGOS?.getByCategoria?.(categoriaId);

          if (cargo) {
            __setCargoNombre(cargo.denominacion || '');

            try { await window.PUNTOS?.ready?.(); } catch (_) {}
            const a01Calc = window.PUNTOS?.getA01For?.(categoriaId, ymSeleccionado) || { actual: 0, previo: 0 };

            const A01pts = Number(a01Calc.actual || 0);
            const A01ptsPrev = Number(a01Calc.previo || 0);
            const A32pts = Number(cargo.A32 || 0);
            const A44pts = Number(cargo.A44 || 0);

            const mA01 = A01pts * indiceActual;
            const mA01Prev = A01ptsPrev * indicePrevio;
            const mA32 = A32pts * indiceActual;
            const mA44 = A44pts * indiceActual;

            sueldoBasico = mA01;
            sueldoBasicoExc = mA01Prev;

            a01 = (mA01 / 30) * diasBaseNum;
            a01Exc = (mA01Prev / 30) * diasExcNum;

            const a01Cell = document.getElementById('a01Importe'); if (a01Cell) a01Cell.textContent = fmtAR(a01);
            const a01ExcCell = document.getElementById('a01Exc'); if (a01ExcCell) a01ExcCell.textContent = fmtAR(a01Exc);

            const show32 = A32pts > 0;
            const show44 = A44pts > 0;

            if (show32) {
              const a32Base = (mA32 / 30) * diasBaseNum;
              const row32 = document.getElementById('rowA32'); if (row32) row32.style.display = 'table-row';
              const a32Cell = document.getElementById('a32Importe'); if (a32Cell) a32Cell.textContent = fmtAR(a32Base);
              totalParcial += Number(a32Base || 0);
            }
            if (show44) {
              const a44Base = (mA44 / 30) * diasBaseNum;
              const row44 = document.getElementById('rowA44'); if (row44) row44.style.display = 'table-row';
              const a44Cell = document.getElementById('a44Importe'); if (a44Cell) a44Cell.textContent = fmtAR(a44Base);
              totalParcial += Number(a44Base || 0);
            }
          } else {
            __setCargoNombre(null);
            const a01Cell = document.getElementById('a01Importe'); if (a01Cell) a01Cell.textContent = '0,00';
            const a01ExcCell = document.getElementById('a01Exc'); if (a01ExcCell) a01ExcCell.textContent = '0,00';
            const r32 = document.getElementById('rowA32'), r44 = document.getElementById('rowA44');
            const c32 = document.getElementById('a32Importe'), c44 = document.getElementById('a44Importe');
            if (r32) r32.style.display = 'none';
            if (r44) r44.style.display = 'none';
            if (c32) c32.textContent = '0,00';
            if (c44) c44.textContent = '0,00';
            sueldoBasico = 0;
            sueldoBasicoExc = 0;
            a01 = 0;
            a01Exc = 0;
          }
        }
      }

      a03 = (sueldoBasico * (antiguedadPts / 100)) / 30 * Number(diasBase || 0);
      a04 = (sueldoBasico * (radioPorcentaje / 100)) / 30 * Number(diasBase || 0);
      a03Exc = (sueldoBasicoExc * (antiguedadPts / 100)) / 30 * Number(diasExc || 0);
      a04Exc = (sueldoBasicoExc * (radioPorcentaje / 100)) / 30 * Number(diasExc || 0);

      liqDato.a01.textContent = fmtAR(a01);
      liqDato.a03.textContent = fmtAR(a03);
      liqDato.a04.textContent = fmtAR(a04);
      liqDato.a01Exc.textContent = fmtAR(a01Exc);
      liqDato.a03Exc.textContent = fmtAR(a03Exc);
      liqDato.a04Exc.textContent = fmtAR(a04Exc);

      totalParcial += Number(a01 || 0) + Number(a03 || 0) + Number(a04 || 0);

      let e66Base = 0, e66Exc = 0;
      let e60Base = 0, e60Exc = 0;

      (async function calcA56(){
        const usar = document.getElementById('optA56')?.checked === true;
        const $rowBase = document.getElementById('rowA56');
        const $outBase = document.getElementById('a56Importe');
        if (!$outBase) return;

        if ($rowBase) $rowBase.style.display = usar ? 'table-row' : 'none';

        let base = 0, exc = 0;
        try { await window.CODIGOS?.A56?.ready?.(); } catch(e){}

        if (usar) {
          const tipo  = (window.getTipoCargo?.() || '').toUpperCase();  // 'CARGOS'|'HCNM'|'HCNS'
          const horas = Number(window.getHorasSeleccionadas?.() || 0);
          if (tipo === 'CARGOS') {
            const mAct  = window.CODIGOS.A56.mensualCargo(ymSeleccionado);
            const mPrev = window.CODIGOS.A56.mensualCargo(ymPrevSeleccionado);
            base = window.CODIGOS.A56.prorrateo(mAct,  diasBase);
            exc  = window.CODIGOS.A56.prorrateo(mPrev, diasExc);
          } else if (tipo === 'HCNM' || tipo === 'HCNS') {
            const mAct  = window.CODIGOS.A56.mensualHora(ymSeleccionado,  tipo, horas);
            const mPrev = window.CODIGOS.A56.mensualHora(ymPrevSeleccionado, tipo, horas);
            base = window.CODIGOS.A56.prorrateo(mAct,  diasBase);
            exc  = window.CODIGOS.A56.prorrateo(mPrev, diasExc);
          }
        }

        // pintar base
        $outBase.textContent = Number(base||0).toLocaleString('es-AR', { minimumFractionDigits:2, maximumFractionDigits:2 });

        // pintar F56 en complemento (solo si hay excedente y A56 activo)
        updateComplementoRow?.('F56', usar && Number(diasExc||0) > 0, exc);

        // sumar A56 base al total parcial
        if (usar && typeof totalParcial === 'number') {
          totalParcial += Number(base||0);
          liqDato.totalParcial.textContent = fmtAR(totalParcial);
        }
      })();
      /* === E66 (30d escalado por índice) + F66 (excedente mes anterior) === */
      function updateComplementoRow(code, visible, valor) {
        const rowId = (code === 'E29C') ? 'rowE29_comp' : ('row' + code);
        const cellId =
          code === 'F66'  ? 'f66Importe'     :
          code === 'F60'  ? 'f60Importe'     :
          code === 'F56'  ? 'f56Importe'     :
          code === 'E29C' ? 'e29CompImporte' : null;

        const row  = document.getElementById(rowId);
        const cell = cellId ? document.getElementById(cellId) : null;

        if (row)  row.style.display = visible ? 'table-row' : 'none';
        if (cell) cell.textContent  = (visible ? Number(valor || 0) : 0)
                                    .toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      (async function calcE66() {
        const chk = document.getElementById('optE66');
        const rowE = document.getElementById('rowE66');
        const outE = document.getElementById('e66Importe');

        const usar = chk?.checked === true;
        const ymSel = document.getElementById('indicePeriodo')?.value
                   || document.getElementById('indiceMes')?.value
                   || '';

        let tipo = tipoSel || 'CARGOS';
        let horas = esHoras ? (horasSeleccionadas > 0 ? horasSeleccionadas : 1) : 1;
        const antigAnios = antiguedadAnios;

        if (rowE) rowE.style.display = usar ? 'table-row' : 'none';

        const resetOutputs = () => {
          if (outE) outE.textContent = '0,00';
          updateComplementoRow('F66', false);
        };

        if (!usar || !ymSel || !window.CODIGOS?.E66) {
          resetOutputs();
          return;
        }

        try {
          const base = await window.CODIGOS.E66.getImporte({
            ym: ymSel, tipo, horas, dias: Number(diasBase || 0), antigAnios
          });
          const exc = await window.CODIGOS.E66.getImportePrev({
            ym: ymSel, tipo, horas, dias: Number(diasExc || 0), antigAnios
          });

          if (outE) outE.textContent = (base || 0).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          updateComplementoRow('F66', usar && (Number(diasExc || 0) > 0), exc);

          if (typeof totalParcial === 'number') {
            totalParcial += Number(base || 0);
            liqDato.totalParcial.textContent = fmtAR(totalParcial);
          }
        } catch (err) {
          console.warn('E66 calc error:', err);
          resetOutputs();
        }
      })();

      /* === E60 base (30 días) + F60 complemento (índice mes anterior) === */
      (function calcE60() {
        const chk = document.getElementById('optE60');
        const outBase = document.getElementById('e60Importe');
        const rowE60 = document.getElementById('rowE60');
        if (!chk || !outBase) return;

        const esCargo = !esHoras;
        const diasBaseCalc = Number(diasBase) || 0;
        const diasExcCalc  = Number(diasExc) || 0;

        const usarE60 = chk.checked && esCargo && window.CODIGOS?.E60;

        if (usarE60) {
          e60Base = window.CODIGOS.E60.getImporteBase({
            dias: diasBaseCalc,
            antigAnios: antiguedadAnios,
            indiceActual: indiceActual
          }) || 0;

          e60Exc = window.CODIGOS.E60.getImporteComplemento({
            dias: diasExcCalc,
            antigAnios: antiguedadAnios,
            indiceAnterior: indicePrevio
          }) || 0;
        } else {
          e60Base = 0;
          e60Exc = 0;
        }

        if (outBase) outBase.textContent = (e60Base || 0).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        if (rowE60) rowE60.style.display = (chk.checked && esCargo) ? 'table-row' : 'none';
        updateComplementoRow('F60', usarE60 && (Number(diasExc) > 0), e60Exc);

        if (usarE60) {
          totalParcial += Number(e60Base || 0);
        }
      })();

      (function complementoExtras() {
        const diasExcNum = Number(diasExc || 0);

        const a56Checked = document.getElementById('optA56')?.checked === true;
        updateComplementoRow('F56', a56Checked && diasExcNum > 0, 0);

        const tipoSelLocal = (typeof getTipoCargo === 'function') ? (getTipoCargo() || '') : '';
        const esHorasLocal = (tipoSelLocal === 'HCNM' || tipoSelLocal === 'HCNS');
        const esCargo = !esHorasLocal;

        const rowE29Base = document.getElementById('rowE29');
        const e29BaseVisible = !!rowE29Base && rowE29Base.style.display !== 'none';

        const showE29Comp = esCargo && (diasExcNum > 0) && e29BaseVisible;
        updateComplementoRow('E29C', showE29Comp, 0);
      })();
      liqDato.totalParcial.textContent = fmtAR(totalParcial);
    }

    async function update() {
      const start = parseDate(inputInicio.value);
      const end = parseDate(inputFin.value);
      const baja = inputBaja.checked;
      const suplente = inputSuplente.checked;

      if (baja) { finLabel2.textContent = 'INCLUIDO'; } else { finLabel2.textContent = 'NO incluido'; }

      if (!start || !end || end < start) {
        periodoLabel.textContent = '—';
        renderDesglose([]);
        diasSAC.textContent = '—';
        decimasBlock.style.display = 'none';
        try {
          await calculateLiq(null, null, baja);
        } catch (err) {
          console.warn('calculateLiq error:', err);
        }
        return;
      }

      periodoLabel.textContent = `${fmtDMY(start)} al ${fmtDMY(end)}`;
      const rows = breakdown30_360(start, end, baja);
      renderDesglose(rows);

      const sacAnio = parseInt(selectAnioSAC.value);
      const sacSem = parseInt(selectSemSAC.value);
      const diasSemestre = calcularSAC(rows, sacAnio, sacSem);
      diasSAC.textContent = diasSemestre;

      const decimasData = calcularDecimas(rows);
      decimasTotal.textContent = decimasData.total;
      decimasDetalle.textContent = decimasData.detalle || '—';
      decimasBlock.style.display = (baja && suplente && decimasData.total > 0) ? 'block' : 'none';


      try {
        await calculateLiq(start, end, baja);
      } catch (err) {
        console.warn('calculateLiq error:', err);
      }

    }
    // Event Listeners
    inputInicio.addEventListener('change', update);
    inputFin.addEventListener('change', update);
    inputBaja.addEventListener('change', update);
    inputBaja.addEventListener('input', update);
    inputIndiceMes.addEventListener('input', update);
    inputIndiceMesPrev.addEventListener('input', update);
    inputAntiguedad.addEventListener('input', function () { uiUpdateAntigPct(); update(); });
    selectRadio.addEventListener('change', update);
    selectAnioSAC.addEventListener('change', update);
    selectSemSAC.addEventListener('change', update);
    // Initial call to set up the UI correctly
    uiUpdateAntigPct();
    update();
  </script>
  <script>
    (function () {
      const orig = document.getElementById('indiceMesPrev');
      const clone = document.getElementById('indiceMesPrev_clone');
      if (!orig || !clone) return;

      // Keep values in sync both ways
      const sync = (from, to) => { to.value = from.value; };
      orig.addEventListener('input', () => sync(orig, clone));
      clone.addEventListener('input', () => sync(clone, orig));
      // initialize
      sync(orig, clone);

      function updateToolbarVisibility() {
        // read excedente days from the pill element inside complementoBox
        const pill = document.querySelector('#complementoBox .pill');
        let exced = 0;
        if (pill) {
          const match = pill.textContent.match(/(\d+)/);
          if (match) exced = parseInt(match[1], 10);
        }
        document.getElementById('indicePrevToolbar').style.display = exced > 0 ? 'flex' : 'none';
      }

      // Observe mutations in complementoBox to catch updates to the pill
      const target = document.getElementById('complementoBox');
      const mo = new MutationObserver(updateToolbarVisibility);
      mo.observe(target, { childList: true, subtree: true, characterData: true });

      // Also run on load and when dates/inputs change
      updateToolbarVisibility();
      ['fechaInicio', 'fechaFin', 'bajaCheck', 'indiceMes', 'radioDocente', 'antiguedadAnios'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updateToolbarVisibility);
        if (el) el.addEventListener('change', updateToolbarVisibility);
      });
    })();
  </script>
  <script>
    (function () {
      function ensureSelectPlaceholder(selectEl, text = '— Seleccionar —') {
        if (!selectEl) return;
        let ph = selectEl.querySelector('option[value=""]');
        if (!ph) {
          ph = document.createElement('option');
          ph.value = '';
          ph.textContent = text;
          ph.disabled = true;
          selectEl.insertBefore(ph, selectEl.firstChild);
        } else {
          ph.textContent = text;
          ph.disabled = true;
          if (selectEl.firstElementChild !== ph) {
            selectEl.insertBefore(ph, selectEl.firstChild);
          }
        }
        ph.selected = true;
        selectEl.value = '';
      }

      function preventPlaceholderSelection(selectEl) {
        if (!selectEl) return;
        selectEl.addEventListener('change', () => {
          if (selectEl.value === '') {
            selectEl.blur();
          }
        });
      }

      window.ensureSelectPlaceholder = ensureSelectPlaceholder;
      window.preventPlaceholderSelection = preventPlaceholderSelection;

      function setupCargoSelect() {
        const sel =
          document.querySelector('#tipoSeleccion') ||
          document.querySelector('#cargoSelect') ||
          document.querySelector('#selectCargo') ||
          document.querySelector('#cargosSelect') ||
          document.querySelector('[data-role="cargo-select"]');

        if (!sel) return;

        ensureSelectPlaceholder(sel);
        preventPlaceholderSelection(sel);
        sel.value = '';
        sel.dispatchEvent(new Event('change', { bubbles: true }));

        const mo = new MutationObserver(() => {
          ensureSelectPlaceholder(sel);
          if (!sel.value) {
            sel.value = '';
            sel.dispatchEvent(new Event('change', { bubbles: true }));
          }
        });
        mo.observe(sel, { childList: true });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupCargoSelect);
      } else {
        setupCargoSelect();
      }
    })();
  </script>
  <script>
    // === Extras visibility controller (immediate + DOMContentLoaded) ===
    (function () {
      function $(id) { return document.getElementById(id); }
      const chkSuplente = $('suplente');
      const optA56 = $('optA56');
      const optE66 = $('optE66');
      const optE60 = $('optE60');

      function ensureExtraRows() {
        let tbody = document.getElementById('a04Importe')?.closest('tbody') || document.getElementById('liqBaseBody');
        if (!tbody) return;
        function mkRow(id, code, title) {
          if (document.getElementById(id)) return;
          const tr = document.createElement('tr'); tr.id = id; tr.style.display = 'none';
          const td1 = document.createElement('td'); td1.title = title; td1.innerHTML = '<b>' + code + '</b>';
          const td2 = document.createElement('td'); td2.textContent = '$';
          const td3 = document.createElement('td'); td3.id = id.replace('row', '').toLowerCase() + 'Importe'; td3.textContent = '0,00';
          tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
          // insert right after A04 row if exists, else append
          const a04 = document.getElementById('a04Importe')?.parentElement;
          if (a04) { a04.insertAdjacentElement('afterend', tr); } else if (tbody) { tbody.appendChild(tr); }
        }
        mkRow('rowA56', 'A56', 'Estado Docente');
        mkRow('rowE29', 'E29', 'Equipamiento Suplentes');
        mkRow('rowE66', 'E66', 'Suma Remunerativa y bonificable por antigüedad');
        mkRow('rowE60', 'E60', 'Suma Remunerativa y bonificable por antigüedad (solo cargos)');
      }

      const rowA56 = $('rowA56');
      const rowE29 = $('rowE29');
      const rowE66 = $('rowE66');
      const rowE60 = $('rowE60');

      function isCargoSeleccionado() {
        const tipo = (typeof getTipoCargo === 'function') ? getTipoCargo() : '';
        return tipo !== 'HCNM' && tipo !== 'HCNS';
      }

      function refreshExtrasVisibility() {
        ensureExtraRows();
        const esCargo = isCargoSeleccionado();
        if (rowA56) rowA56.style.display = (optA56 && optA56.checked) ? 'table-row' : 'none';
        if (rowE66) rowE66.style.display = (optE66 && optE66.checked) ? 'table-row' : 'none';
        if (rowE60) rowE60.style.display = (optE60 && optE60.checked && esCargo) ? 'table-row' : 'none';
        if (rowE29) rowE29.style.display = (chkSuplente && chkSuplente.checked && esCargo) ? 'table-row' : 'none';
      }

      function bind(el, ev) { if (el) el.addEventListener(ev, function () { refreshExtrasVisibility(); if (typeof update === 'function') update(); }); }

      function __extrasInit() {
        ensureExtraRows();
        refreshExtrasVisibility();
        // Bind changes
        ['tipoSeleccion', 'catId', 'horasHCNM', 'horasHCNS', 'baja', 'suplente',
          'optA56', 'optE66', 'optE60', 'radioDocente', 'antiguedadAnios', 'indiceMes', 'indiceMesPrev']
          .forEach(id => { const el = $(id); if (el) { bind(el, 'change'); bind(el, 'input'); } });
      }

      // Run immediately if DOM is already ready; otherwise bind to DOMContentLoaded
      if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', __extrasInit); } else { __extrasInit(); if (typeof update === 'function') update(); }

      // Also observe the base table for updates that might rewrite DOM
      const target = $('liqBlock');
      if (target && 'MutationObserver' in window) {
        const mo = new MutationObserver(() => refreshExtrasVisibility());
        mo.observe(target, { childList: true, subtree: true });
        // short-lived enforcement in case of late DOM updates
        let __count = 0; const __iv = setInterval(() => { try { refreshExtrasVisibility(); } catch (e) { } if (++__count > 10) clearInterval(__iv); }, 200);
      }
    })();
  </script>
<script>
(function(){
  function ensureRowIn(tbody, rowId, code, title, cellId, afterCellId){
    if (document.getElementById(rowId)) return;
    const tr = document.createElement('tr'); tr.id = rowId;
    const td1 = document.createElement('td'); td1.title = title; td1.innerHTML = '<b>'+code+'</b>';
    const td2 = document.createElement('td'); td2.textContent = '$';
    const td3 = document.createElement('td'); td3.id = cellId; td3.textContent = '0,00';
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    if (afterCellId) {
      const afterEl = document.getElementById(afterCellId);
      if (afterEl) afterEl.parentElement.insertAdjacentElement('afterend', tr);
      else tbody.appendChild(tr);
    } else {
      tbody.appendChild(tr);
    }
  }

  // Crea A32/A44 en Base y elimina restos en Complemento si existieran
  window.__ensureA32A44Rows = function(){
    const tbodyBase = document.getElementById('liqBaseBody') || document.querySelector('#liqBaseBody');
    if (tbodyBase){
      const afterId = 'a04Importe'; // insertar tras A04
      ensureRowIn(tbodyBase, 'rowA32', 'A32', 'Responsabilidad jerárquica', 'a32Importe', afterId);
      ensureRowIn(tbodyBase, 'rowA44', 'A44', 'Código especial', 'a44Importe', 'a32Importe');
    }
    // borrar cualquier fila A32/A44 en Complemento
    const a32E = document.getElementById('a32Exc'); if (a32E) a32E.closest('tr')?.remove();
    const a44E = document.getElementById('a44Exc'); if (a44E) a44E.closest('tr')?.remove();
  };
})();
</script>
  <script>
  document.getElementById('optE66')?.addEventListener('change', () => {
    const on = document.getElementById('optE66').checked;
    // E66 (columna base)
    document.getElementById('rowE66')?.style.setProperty('display', on ? '' : 'none');
    // F66 (columna complemento) se recalcula y decide su visibilidad en calcE66()
    document.getElementById('rowF66')?.style.setProperty('display', 'none');
    // Recalcular todo
    if (typeof update === 'function') update();
  });
</script>
  <script>
  /* Antigüedad: solo input numérico; limpiar restos y mantener look unificado */
  (function () {
    // Limpiar posibles restos/fantasmas
    document.querySelectorAll('#antiguedadSelect, #antiguedadPeriodo, #antiguedadOptions, .antiguedad-ghost')
      .forEach(node => node.remove());

    const input = document.getElementById('antiguedadAnios');
    if (!input) return;
    // Atributos mínimos del control (no tocar estructura HTML)
    try {
      input.setAttribute('type', 'number');
      if (!input.hasAttribute('min'))  input.setAttribute('min', '0'); else input.min = '0';
      if (!input.hasAttribute('max'))  input.setAttribute('max', '40'); else input.max = '40';
      if (!input.hasAttribute('step')) input.setAttribute('step', '1'); else input.step = '1';
    } catch (e) { /* noop */ }

    // Asegurar tipeo libre con límites razonables (0..40). Ajustar si tu lógica cambia.
    const clamp = n => Math.max(0, Math.min(40, Number(n) || 0));
    input.addEventListener('input', () => {
      const n = clamp(input.value);
      if (String(n) !== String(input.value)) input.value = String(n);
      input.dispatchEvent(new Event('input', { bubbles:true }));
      if (typeof update === 'function') { try { update(); } catch {} }
    });
  })();
  const input = document.getElementById('antiguedadAnios');

const clamp = (n, min, max) => Math.min(max, Math.max(min, n));
const digitCount = v => String(Math.trunc(Math.abs(Number(v)) || 0)).length;

function ajustarAncho() {
  const needed = clamp(digitCount(input.value) + 1, 4, 10);
  input.style.width = `${needed}ch`;
}

ajustarAncho();
input.addEventListener('input', ajustarAncho);
input.addEventListener('change', ajustarAncho);

  </script>

  <script>
  // === Autocomplete y denominación instantánea para #catId ===
  (function(){
    const input = document.getElementById('catId');
    const wrap  = document.getElementById('cargoNombreWrap');
    const nameEl= document.getElementById('cargoNombre');
    if (!input || !wrap || !nameEl) return;

    // Estilos mínimos del dropdown (inyectados sin tocar CSS global)
    const style = document.createElement('style');
    style.textContent = `
      .cat-suggest {
        position: absolute; z-index: 9999; background: #fff; border:1px solid #d6d6e7;
        border-radius:10px; box-shadow: 0 6px 20px rgba(0,0,0,.12); width: 100%; max-height: 260px;
        overflow-y: auto; font-size:14px;
      }
      .cat-suggest-item { padding:8px 10px; display:flex; gap:8px; align-items:center; }
      .cat-suggest-item b { min-width: 56px; text-align:right; }
      .cat-suggest-item:hover, .cat-suggest-item[aria-selected='true'] { background:#f4f6fb; cursor:pointer; }
      .cat-suggest-empty { padding:8px 10px; color:#666; }
      .cat-suggest-wrap { position: relative; display: inline-block; width: 22ch; }
    `;
    document.head.appendChild(style);

    // Envolver input para posicionar el dropdown
    const wrapper = document.createElement('div');
    wrapper.className = 'cat-suggest-wrap';
    input.parentNode.insertBefore(wrapper, input);
    wrapper.appendChild(input);

    // Dropdown
    const dd = document.createElement('div');
    dd.className = 'cat-suggest';
    dd.style.display = 'none';
    wrapper.appendChild(dd);

    let idx = -1;
    let items = [];
    let debounceT = null;

    function showName(txt){
      if (txt && String(txt).trim()){
        nameEl.textContent = txt;
        wrap.style.display = 'block';
      } else {
        nameEl.textContent = '-';
        wrap.style.display = 'none';
      }
    }

    async function ensureData(){ try { await window.CARGOS?.ready?.(); } catch(_){} }

    function renderList(list){
      dd.innerHTML = '';
      items = list || [];
      idx = -1;
      if (!items.length){
        const empty = document.createElement('div');
        empty.className = 'cat-suggest-empty';
        empty.textContent = 'Sin coincidencias...';
        dd.appendChild(empty);
        dd.style.display = 'block';
        return;
      }
      items.forEach((c, i) => {
        const el = document.createElement('div');
        el.className = 'cat-suggest-item';
        el.setAttribute('role','option');
        el.setAttribute('data-index', String(i));
        el.innerHTML = `<b>${c.categoria}</b> <span>${c.denominacion}</span>`;
        el.addEventListener('mousedown', (ev) => {
          ev.preventDefault();
          choose(i);
        });
        dd.appendChild(el);
      });
      dd.style.display = 'block';
    }

    function highlight(newIdx){
      const nodes = dd.querySelectorAll('.cat-suggest-item');
      nodes.forEach(n => n.setAttribute('aria-selected','false'));
      idx = newIdx;
      if (idx >=0 && idx < nodes.length){
        nodes[idx].setAttribute('aria-selected','true');
        const n = nodes[idx];
        const nTop = n.offsetTop, nBottom = nTop + n.offsetHeight;
        if (dd.scrollTop > nTop) dd.scrollTop = nTop;
        else if (dd.scrollTop + dd.clientHeight < nBottom) dd.scrollTop = nBottom - dd.clientHeight;
      }
    }

    function closeDD(){ dd.style.display = 'none'; dd.innerHTML = ''; items = []; idx = -1; }

    function choose(i){
      if (i < 0 || i >= items.length) return;
      const c = items[i];
      input.value = String(c.categoria);
      showName(c.denominacion || '');
      closeDD();
      if (typeof window.update === 'function') { try { window.update(); } catch(_){} }
    }

    async function runSearch(){
      await ensureData();
      const q = String(input.value || '').trim();
      if (!q){
        showName(null);
        closeDD();
        return;
      }
      const isNum = /^\d+$/.test(q);
      if (isNum){
        const cargo = window.CARGOS?.getByCategoria?.(q);
        showName(cargo?.denominacion || null);
        if (cargo && String(cargo.categoria) === q){
          closeDD();
        } else {
          const list = window.CARGOS?.search?.(q) || [];
          if (list.length && String(list[0].categoria) === q){
            closeDD();
          } else {
            renderList(list);
          }
        }
        return;
      }
      const list = window.CARGOS?.search?.(q) || [];
      renderList(list);
      if (list.length === 1 && String(list[0].denominacion || '').toLowerCase() === q.toLowerCase()){
        showName(list[0].denominacion);
      } else {
        showName(null);
      }
    }

    function scheduleSearch(){
      if (debounceT) clearTimeout(debounceT);
      debounceT = setTimeout(runSearch, 120);
    }

    input.addEventListener('input', scheduleSearch);
    input.addEventListener('focus', scheduleSearch);

    input.addEventListener('keydown', (ev) => {
      const open = dd.style.display !== 'none';
      if (ev.key === 'ArrowDown' && open){
        ev.preventDefault();
        highlight(Math.min(idx + 1, items.length - 1));
      } else if (ev.key === 'ArrowUp' && open){
        ev.preventDefault();
        highlight(Math.max(idx - 1, 0));
      } else if (ev.key === 'Enter'){
        if (open && idx >= 0){
          ev.preventDefault();
          choose(idx);
        } else {
          runSearch().then(() => {
            if (!items.length){
              const c = window.CARGOS?.getByCategoria?.(input.value);
              if (c) showName(c.denominacion);
            }
          });
        }
      } else if (ev.key === 'Escape' && open){
        ev.preventDefault();
        closeDD();
      }
    });

    document.addEventListener('click', (ev) => {
      if (!wrapper.contains(ev.target)) closeDD();
    });

  })();
  </script>
  <script>
  // === Autocompletar Fecha Fin con último día del mes actual ===
  (function(){
    const inicio = document.getElementById('inicio');
    const fin    = document.getElementById('fin');
    if (!inicio || !fin) return;

    // Devuelve YYYY-MM-DD del último día del mes actual (según zona local)
    function lastDayOfCurrentMonthISO(){
      const now   = new Date();
      const y     = now.getFullYear();
      const m     = now.getMonth();
      const last  = new Date(y, m + 1, 0);
      const pad   = n => String(n).padStart(2, '0');
      return `${y}-${pad(m + 1)}-${pad(last.getDate())}`;
    }

    function setAutoFin(){
      fin.value = lastDayOfCurrentMonthISO();
      fin.dataset.autofill = "1";
      if (typeof window.update === 'function') { try { window.update(); } catch(_){} }
    }

    ['input','change'].forEach(ev => {
      fin.addEventListener(ev, () => { delete fin.dataset.autofill; });
    });

    ['change','blur'].forEach(ev => {
      inicio.addEventListener(ev, () => {
        if (!inicio.value){
          fin.value = "";
          delete fin.dataset.autofill;
          if (typeof window.update === 'function') { try { window.update(); } catch(_){} }
          return;
        }
        if (!fin.value || fin.dataset.autofill === "1"){
          setAutoFin();
        }
      });
    });

    if (inicio.value && (!fin.value || fin.dataset.autofill === "1")){
      setAutoFin();
    }
  })();
  </script>\n  <script>
  // === Autocompletar Fecha Fin con último día del mes actual ===
  (function(){
    const inicio = document.getElementById('inicio');
    const fin    = document.getElementById('fin');
    if (!inicio || !fin) return;

    // Devuelve YYYY-MM-DD del último día del mes actual (según zona local)
    function lastDayOfCurrentMonthISO(){
      const now   = new Date();
      const y     = now.getFullYear();
      const m     = now.getMonth();
      const last  = new Date(y, m + 1, 0);
      const pad   = n => String(n).padStart(2, '0');
      return `${y}-${pad(m + 1)}-${pad(last.getDate())}`;
    }

    function setAutoFin(){
      fin.value = lastDayOfCurrentMonthISO();
      fin.dataset.autofill = "1";
      if (typeof window.update === 'function') { try { window.update(); } catch(_){} }
    }

    ['input','change'].forEach(ev => {
      fin.addEventListener(ev, () => { delete fin.dataset.autofill; });
    });

    ['change','blur'].forEach(ev => {
      inicio.addEventListener(ev, () => {
        if (!inicio.value){
          fin.value = "";
          delete fin.dataset.autofill;
          if (typeof window.update === 'function') { try { window.update(); } catch(_){} }
          return;
        }
        if (!fin.value || fin.dataset.autofill === "1"){
          setAutoFin();
        }
      });
    });

    if (inicio.value && (!fin.value || fin.dataset.autofill === "1")){
      setAutoFin();
    }
  })();
  </script>
  <script>
  // Safety net: remover text-nodes que sean exactamente "\n"
  (function(){
    function cleanNodeTree(root){
      const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
      const toRemove = [];
      while (walker.nextNode()){
        const n = walker.currentNode;
        if (n.nodeValue && n.nodeValue.trim() === "\\n") toRemove.push(n);
      }
      toRemove.forEach(n => n.parentNode && n.parentNode.removeChild(n));
    }
    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', () => cleanNodeTree(document.body));
    } else {
      cleanNodeTree(document.body);
    }
  })();
  </script>
  <!-- Módulo de PUNTOS (A01 acumulado por mes con incrementos y multiplicadores) -->
  <script>
  (function(){
    const INC_PATHS = [
      'docs/data/codigos/incrementos.json',
      'data/codigos/incrementos.json',
      'incrementos.json'
    ];
    const MUL_PATHS = [
      'docs/data/codigos/multiplicadores.json',
      'data/codigos/multiplicadores.json',
      'multiplicadores.json'
    ];

    async function fetchFirst(paths){
      for (const p of paths){
        try {
          const url = new URL(p, location.href);
          if (window.__assetVersion) url.searchParams.set('v', window.__assetVersion);
          const r = await fetch(url, { cache:'no-store' });
          if (r.ok) return await r.json();
        } catch (e) {}
      }
      throw new Error('No pude cargar: ' + paths.join(' | '));
    }

    function ymToNum(ym){ return Number(String(ym).replace('-', '')); }
    function prevYM(ym){
      let [y,m] = String(ym).split('-').map(Number);
      m -= 1; if (m === 0){ y--; m = 12; }
      return `${y}-${String(m).padStart(2,'0')}`;
    }

    let INC = null;
    let MUL = null;

    async function ensure(){
      if (INC && MUL) return;
      const [inc, mul] = await Promise.all([ fetchFirst(INC_PATHS), fetchFirst(MUL_PATHS) ]);
      INC = inc; MUL = mul;
    }

    function multForCategoria(categoria){
      const d = Number(MUL?.default ?? 1);
      const m = Number(MUL?.categorias?.[String(categoria)] ?? d);
      return Number.isFinite(m) ? m : 1;
    }

    function a01Acumulado(cargo, ymTarget){
      if (!cargo) return 0;
      const baseYM = String(INC?.base_month || '2024-08');
      const tNum = ymToNum(ymTarget);
      const bNum = ymToNum(baseYM);

      let puntos = Number(cargo.A01 || 0);
      const mult = multForCategoria(cargo.categoria);

      for (const ch of (INC?.changes || [])){
        const m = String(ch.month);
        const n = ymToNum(m);
        if (n > bNum && n <= tNum){
          puntos += Number(ch.delta || 0) * mult;
        }
      }
      return puntos;
    }

    window.PUNTOS = {
      ready: async () => { await ensure(); return true; },
      getA01For: (categoria, ymActual) => {
        const cargo = window.CARGOS?.getByCategoria?.(Number(categoria));
        if (!cargo || !INC || !MUL) return { actual:0, previo:0 };
        const ymPrev = prevYM(ymActual);
        return {
          actual: a01Acumulado(cargo, ymActual),
          previo: a01Acumulado(cargo, ymPrev)
        };
      },
      prevYM
    };
  })();
  </script>
<!-- Activación del Store (vanilla ESM) -->
<script type="module">
  import * as Store from './js/store.js';

  window.Store = Store;

  Store.subscribe(async () => {
    try {
      if (window.PUNTOS?.ready) await window.PUNTOS.ready();
      const startEl = document.getElementById('inicio')
                   || document.getElementById('fechaInicio')
                   || document.getElementById('start')
                   || document.getElementById('startDate');
      const endEl   = document.getElementById('fin')
                   || document.getElementById('fechaFin')
                   || document.getElementById('end')
                   || document.getElementById('endDate');
      const bajaEl  = document.getElementById('baja');

      const start = startEl?.value || '';
      const end   = endEl?.value   || '';
      const baja  = !!(bajaEl?.checked);

      if (start && end && typeof calculateLiq === 'function') {
        await calculateLiq(start, end, baja);
      }
    } catch (e) {
      console.debug('[Store->calculateLiq] error:', e);
    }
  });

  Store.syncFromDOM();

  ['indicePeriodo', 'catId', 'cargoId', 'diasBase', 'diasExc', 'inicio', 'fin', 'fechaInicio', 'fechaFin']
    .forEach((id) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('change', () => Store.syncFromDOM());
      el.addEventListener('input',  () => Store.syncFromDOM());
    });
</script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const horasInp = document.getElementById('horasValor');
    if (!horasInp) return;

    horasInp.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter') {
        ev.preventDefault();
        if (typeof update === 'function') {
          try { update(); } catch (e) {}
        }
        horasInp.blur();
      } else if (ev.key === 'Escape') {
        horasInp.value = '';
        try {
          const raw = localStorage.getItem('liq_prefs') || '{}';
          const d = JSON.parse(raw) || {};
          d.horas = '';
          localStorage.setItem('liq_prefs', JSON.stringify(d));
        } catch (e) {}
        if (typeof update === 'function') {
          try { update(); } catch (e) {}
        }
      }
    });
  });
  </script>
  </body>

</html>

