<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Liquidación de Sueldos</title>
  <link rel="icon" href="images/favicon-32x32.png" type="image/png" />
  <link id="app-css" rel="stylesheet" href="css/styles.css">
</head>

<script>
(async () => {
  const cssPath = "css/styles.css";
  let version = "";

  try {
    // Pedimos SOLO cabeceras para obtener ETag / Last-Modified
    const res = await fetch(cssPath, { method: "HEAD", cache: "no-store" });
    version =
      (res.headers.get("etag") || res.headers.get("last-modified") || "").replace(/"/g,"");
  } catch (e) {
    // Fallback: timestamp (por si algo raro impide leer cabeceras)
    version = String(Date.now());
  }

  // Guardamos la versión para reutilizar en otros assets (JSON, imágenes, etc.)
  window.__assetVersion = version || String(Date.now());

  // Actualizamos el href del <link> para forzar recarga si cambió el contenido
  const link = document.getElementById("app-css");
  if (link) {
    const url = new URL(link.getAttribute("href"), location.href);
    url.searchParams.set("v", window.__assetVersion);
    // Sólo reasignamos si cambió para evitar recargas innecesarias
    if (link.href !== url.href) link.href = url.pathname + "?" + url.searchParams.toString();
  }
})();
</script>

<script src="js/codigos.js"></script>
<script src="js/codigos/e66.js"></script>

<body>
  <div class="card">
    <h1>Liquidación de Sueldos</h1>
    <div class="grid-2">
      <div class="leftCol">
        <div class="sidebar">
          <!-- === Nuevo bloque: Seleccionar Cargos/Horas Cátedra === -->
          <div id="cargoHorasBlock" class="result">
            <label class="title" style="display:block;margin-bottom:8px;">Seleccionar Cargos/Horas Cátedra</label>

            <!-- Lista desplegable principal -->
            <label class="muted">Lista desplegable</label>
            <select id="tipoSeleccion">
              <option value="">— Seleccionar —</option>
              <option value="CARGOS">Cargos</option>
              <option value="HCNM">Horas Cátedra Nivel Medio</option>
              <option value="HCNS">Horas Cátedra Nivel Superior</option>
            </select>

            <!-- Panel CARGOS: ingresar categoría/ID -->
            <div id="panelCargos" style="display:none; margin-top:10px;">
              <label class="muted">Cargos</label>
              <input id="catId" type="number" min="1" step="1" placeholder="Completar con el número de categoría" style="width:22ch;"/>
              <div class="muted" style="margin-top:6px;">Ej.: 55, 28, 167…</div>
            </div>

            <!-- Panel HCNM: horas nivel medio -->
            <div id="panelHCNM" style="display:none; margin-top:10px;">
              <label class="muted">Horas Cátedra Nivel Medio</label>
              <input id="horasHCNM" type="number" min="1" step="1" placeholder="Completar con la cantidad de horas cátedra" style="width:22ch;"/>
            </div>

            <!-- Panel HCNS: horas nivel superior -->
            <div id="panelHCNS" style="display:none; margin-top:10px;">
              <label class="muted">Horas Cátedra Nivel Superior</label>
              <input id="horasHCNS" type="number" min="1" step="1" placeholder="Completar con la cantidad de horas cátedra" style="width:22ch;"/>
            </div>
          </div>
        </div>
        <div class="stack">
          <div>
            <label>Fecha Inicio</label>
            <input id="inicio" placeholder="dd/mm/aaaa" type="date" />
          </div>
          <div>
            <label>Fecha Fin</label>
            <input id="fin" placeholder="dd/mm/aaaa" type="date" />
          </div>
          <label style="margin-top:4px;">
            <label style="display:inline-flex;align-items:center;gap:8px;user-select:none;cursor:pointer;"
              for="baja"><span>BAJA</span><input id="baja" type="checkbox" /></label><label
              style="display:inline-flex;align-items:center;gap:8px;user-select:none;cursor:pointer;margin-left:12px;"
              for="suplente"><span>SUPLENTE</span><input id="suplente" type="checkbox" /></label>
          </label>
        </div>
        <div class="result" id="liqBlock">
          <div class="title">Liquidación</div>

<div class="row" id="indicesRow" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
  <label class="muted" style="position:relative; display:inline-flex; align-items:center; gap:8px;">
    Índice del mes
    <input id="indiceMes" step="0.0001" class="num-display" type="number" value="787.1022" readonly />
    <select id="indicePeriodo" aria-label="Mes y año del índice"></select>
  </label>

  <div id="indicePrevToolbar" style="display:none;">
    <label class="muted">
      Índice mes anterior
      <input id="indiceMesPrev_clone" name="indiceMesPrev_clone" step="0.0001" class="num-display" type="number" value="772.4261" readonly />
    </label>
  </div>
</div>



<!-- Código viejo (eliminar si funciona el cambio)
          <div id="indicesRow"
            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;"><label
              class="muted">Índice del mes
              <input id="indiceMes" step="0.0001" style="width:auto-size"; margin-left:6px;" type="number" value="787.1022" />
              <select id="indicePeriodo" aria-label="Mes y año del índice"></select>
            </label>
            <div id="indicePrevToolbar" style="display:none;"><label class="muted">Índice mes anterior
                <input id="indiceMesPrev_clone" name="indiceMesPrev_clone" step="0.0001" style="width:auto-size;"
                  type="number" value="772.4261" />
              </label></div>
          </div>
-->
          <div class="row"
            style="display:flex; flex-direction:column; align-items:flex-start; gap:6px; margin:8px 0 4px 0;"><label
              class="muted">Antigüedad (años)
              <input id="antiguedadAnios" min="0" step="1" type="number"
                value="0" /> <span class="pill" id="antiguedadPct" style="margin-left:8px;">0%</span>
              <label class="muted">Radio
                <select id="radioDocente" style="margin-left:6px;">
                  <option value="0">Sin radio</option>
                  <option value="40">Radio 1 (40%)</option>
                  <option value="50">Radio 2 (50%)</option>
                  <option value="60">Radio 3 (60%)</option>
                  <option value="90">Radio 4 (90%)</option>
                  <option value="110">Radio 5 (110%)</option>
                  <option value="130">Radio 6 (130%)</option>
                  <option value="150">Radio 7 (150%)</option>
                </select>
              </label>
              <div id="optExtras" class="muted">
                <span class="label">Extras:</span>

                <label title="Estado Docente">A56
                  <input id="optA56" type="checkbox">
                </label>

                <label title="Suma Remun. y bonificable por antigüedad">E66
                  <input id="optE66" type="checkbox">
                </label>

                <label title="Suma Remun. y bonificable por antigüedad (solo cargos)">E60
                  <input id="optE60" type="checkbox">
                </label>
              </div>

              <label class="muted" style="display:none;">Índice mes anterior
                <input id="indiceMesPrev" step="0.0001" style="width:12ch; margin-left:6px;" type="number"
                  value="772.4261" />
              </label>
          </div>
          <span class="pill"><b id="diasLiq">0</b></span>
          <div class="liq-columns">
            <div>
              <table class="tabla-codigos">
                <thead>
                  <tr>
                    <th>Código</th>
                    <th></th>
                    <th>Importe</th>
                  </tr>
                </thead>
                <tbody id="liqBaseBody">
                  <tr>
                    <td><b>A01</b> Sueldo Básico</td>
                    <td>$</td>
                    <td id="a01Importe">0,00</td>
                  </tr>
                  <tr>
                    <td><b>A03</b> Antigüedad</td>
                    <td>$</td>
                    <td id="a03Importe">0,00</td>
                  </tr>
                  <tr>
                    <td><b>A04</b> Radio</td>
                    <td>$</td>
                    <td id="a04Importe">0,00</td>
                  </tr>
                  <tr id="rowA56" style="display:none;">
                    <td title="Estado Docente"><b>A56</b></td>
                    <td>$</td>
                    <td id="a56Importe">0,00</td>
                  </tr>
                  <tr id="rowE29" style="display:none;">
                    <td title="Equipamiento Suplentes"><b>E29</b></td>
                    <td>$</td>
                    <td id="e29Importe">0,00</td>
                  </tr>
                  <tr id="rowE66" data-codigo="E66" style="display:none;">
                    <td title="Suma Remunerativa y bonificable por antigüedad"><b>E66</b></td>
                    <td>$</td>
                    <td><span id="e66Importe">0,00</span></td>
                  </tr>
                  <tr id="rowE60" data-codigo="E60" style="display:none;">
                    <td title="Suma Remunerativa y bonificable por antigüedad (solo cargos)"><b>E60</b></td>
                    <td>$</td>
                    <td><span id="e60Importe">0,00</span></td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <td><b>Total Parcial</b></td>
                    <td>$</td>
                    <td id="totalParcial">0,00</td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div id="complementoBox" style="display:none;; position:relative;">
              <div class="muted" style="margin:6px 0 4px 0;">Complemento</div>
              <div class="pill" style="margin:0 0 6px 0;">Días excedentes: <b id="diasExc">0</b></div>
              <table class="tabla-codigos">
                <thead>
                  <tr>
                    <th>Código</th>
                    <th></th>
                    <th>Importe</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><b>A01</b> Sueldo Básico</td>
                    <td>$</td>
                    <td id="a01Exc">0,00</td>
                  </tr>
                  <tr>
                    <td><b>A03</b> Antigüedad</td>
                    <td>$</td>
                    <td id="a03Exc">0,00</td>
                  </tr>
                  <tr>
                  <tr>
                    <td><b>A04</b> Radio</td>
                    <td>$</td>
                    <td id="a04Exc">0,00</td>
                  </tr>
                  <tr id="rowF66" style="display:none;">
                    <td title="Complemento del código E66 (mes anterior)"><b>F66</b></td>
                    <td>$</td>
                    <td id="f66Importe">0,00</td>
                  </tr>
                  <tr id="rowF60" style="display:none;">
                    <td title="Complemento del código E60 (mes anterior)"><b>F60</b></td>
                    <td>$</td>
                    <td id="f60Importe">0,00</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="muted" style="margin-top:6px;">
            * Si el período supera 30 días: se calculan 30 d con el índice vigente y el excedente con el índice del mes
            anterior.
          </div>
          <div class="muted" style="margin-top:6px;">Criterio: inicio siempre incluido · fin <span id="finLabel2">NO
              incluido</span>.</div>
        </div>
      </div>
      <aside class="rightCol">
        <div class="months-box">
          <div class="months-header">
            <div class="title" style="; margin-left:40px;">Desglose Mensual (30/360)</div>
            <div class="pill" id="periodoLabel">—</div>
          </div>
          <div class="result">
            <table>
              <thead>
                <tr>
                  <th>Mes</th>
                  <th>Días</th>
                </tr>
              </thead>
              <tbody id="tbodyMeses">
                <tr>
                  <td class="muted" colspan="2">Ingresá inicio y fin…</td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td>Total</td>
                  <td id="totalDias">—</td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div class="result">
            <div class="row" style="justify-content:space-between;">
              <div class="title" style="; margin-left:40px;">Días de Aguinaldo</div>
              <div class="row">
                <label class="muted">Año
                  <select id="anioSAC"></select>
                </label>
                <label class="muted">Semestre
                  <select id="semSAC">
                    <option value="1">1º SAC (Ene–Jun)</option>
                    <option value="2">2º SAC (Jul–Dic)</option>
                  </select>
                </label>
              </div>
            </div>
            <div style="margin-top:8px;">
              <span class="muted">Días dentro del semestre seleccionado:</span>
              <span class="title" id="diasSAC">—</span>
            </div>
          </div>
          <div class="result" id="decimasBlock" style="display:none;">
            <div class="title">Décimas</div>
            <div class="muted">(Comprende del 1 Mar al 30 Dic)</div>
            <div style="margin-top:8px;">
              <span class="muted">Total:</span>
              <span class="title" id="decimasTotal">—</span>
            </div>
            <div class="muted" id="decimasDetalle" style="margin-top:6px;">—</div>
          </div>
        </div>
    </div>
    </aside>
  </div>
  </div>
 <script>


/* Selector Mes-Año con <select> nativo, 6 visibles sin reflow + excepción de mes actual faltante */
(function () {
  const MES_ABR = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  const INDICES_URL = 'data/indices.json';

  const selPeriodo  = document.getElementById('indicePeriodo'); // <select>
  const indiceInput = document.getElementById('indiceMes');     // visible (readonly)
  const prevCalc    = document.getElementById('indiceMesPrev'); // oculto (cálculo)

  if (!selPeriodo || !indiceInput || !prevCalc) return;

  const now   = new Date();
  const curYM = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

  const toFixed4 = n => {
    const x = Number(n);
    return Number.isFinite(x) ? x.toFixed(4) : '';
  };
  const labelDeClave = ym => {
    const [y, m] = ym.split('-').map(Number);
    return `${MES_ABR[m-1]}-${y}`;
  };
  const prevYM = k => {
    let [y, m] = k.split('-').map(Number);
    m -= 1; if (m === 0) { y -= 1; m = 12; }
    return `${y}-${String(m).padStart(2,'0')}`;
  };

  let mapa = {};
  let claves = [];
  let latest = null;

  function aplicarPeriodo(k) {
    if (!k || !mapa[k]) return Promise.resolve(false);
    const v = Number(mapa[k]);
    indiceInput.value = toFixed4(v);
    // Excepción: si el mes calendario no existe y estamos en el último disponible,
    // "Índice mes anterior" = mismo valor
    const hasCurrent = mapa[curYM] != null;
    let prevValue;
    if (!hasCurrent && k === latest) {
      prevValue = v;
    } else {
      const kp = prevYM(k);
      prevValue = Number(mapa[kp]);
    }
    prevCalc.value = toFixed4(prevValue);
    const prevClone = document.getElementById('indiceMesPrev_clone');
    if (prevClone) prevClone.value = toFixed4(prevValue);

    const runRecalc = () => {
      indiceInput.dispatchEvent(new Event('input', { bubbles:true }));
      prevCalc.dispatchEvent(new Event('input', { bubbles:true }));
      if (typeof update === 'function') { try { update(); } catch {} }
    };

    const ensure = window.CODIGOS?.E66?.ensureLoaded(k);
    if (ensure && typeof ensure.then === 'function') {
      return ensure.then(() => { runRecalc(); return true; });
    }
    runRecalc();
    return Promise.resolve(true);
  }

  async function init() {
    try {
      const v = window.__assetVersion ? `?v=${window.__assetVersion}` : '';
      const res = await fetch(INDICES_URL + v, { cache: 'no-store' });
      const json = await res.json();
      mapa = json.indices || json;
    } catch (e) {
      console.warn('No se pudo cargar data/indices.json', e);
      selPeriodo.innerHTML = ''; indiceInput.value = ''; prevCalc.value = '';
      return;
    }

    // Construir opciones (todas, orden desc)
    claves = Object.keys(mapa)
      .filter(k => /^\d{4}-\d{2}$/.test(k))
      .sort()
      .reverse();

    selPeriodo.innerHTML = '';
    for (const k of claves) {
      const opt = document.createElement('option');
      opt.value = k;
      opt.textContent = labelDeClave(k);
      selPeriodo.appendChild(opt);
    }

    latest = claves[0] || null;

    // Selección inicial: último disponible
    if (latest) {
      selPeriodo.value = latest;
      const resInit = aplicarPeriodo(selPeriodo.value);
      if (resInit && typeof resInit.then === 'function') {
        resInit.catch(() => {});
      } else {
        window.CODIGOS?.E66?.ensureLoaded(selPeriodo.value).then(() => {
          if (typeof update === 'function') { try { update(); } catch {} }
        });
      }
    }

    // Cambio de período
    selPeriodo.addEventListener('change', () => {
      const clave = selPeriodo.value;
      const res = aplicarPeriodo(clave);
      if (res && typeof res.then === 'function') {
        res.catch(() => {});
        return;
      }
      window.CODIGOS?.E66?.ensureLoaded(clave).then(() => {
        if (typeof update === 'function') { try { update(); } catch {} }
      });
    });

  }

  if (document.readyState !== 'loading') init();
  else document.addEventListener('DOMContentLoaded', init);
})();






    // ===== Utilidades
    function toUTCDate(y, m, d) { return new Date(Date.UTC(y, m, d)); }
    function parseDate(s) { if (!s) return null; const [y, m, d] = s.split('-').map(Number); if (!y || !m || !d) return null; return toUTCDate(y, m - 1, d); }
    function is31MonthNum(m) { return [1, 3, 5, 7, 8, 10, 12].includes(m); }
    function monthNameEs(m) { return ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'][m - 1]; }
    function addMonth(y, m) { return (m === 12) ? { y: y + 1, m: 1 } : { y, m: m + 1 }; }
    function fmtDMY(d) { const y = d.getUTCFullYear(), m = String(d.getUTCMonth() + 1).padStart(2, '0'), da = String(d.getUTCDate()).padStart(2, '0'); return `${da}/${m}/${y}`; }
    function fmtAR(n) { return n.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    // Ajusta el ancho de un <select> al de su opción más larga
    function adjustSelectWidth(sel) {
      if (!sel) return;
      const comp = getComputedStyle(sel);
      const test = document.createElement('span');
      test.style.visibility = 'hidden'; test.style.whiteSpace = 'pre'; test.style.position = 'absolute'; test.style.font = comp.font; test.style.letterSpacing = comp.letterSpacing;
      document.body.appendChild(test);
      let max = 0;
      for (const opt of sel.options) { test.textContent = opt.text; const w = test.offsetWidth; if (w > max) max = w; }
      document.body.removeChild(test);
      const paddings = parseFloat(comp.paddingLeft) + parseFloat(comp.paddingRight);
      const extra = paddings + 36;
      sel.style.width = Math.ceil(max + extra) + 'px';
    }

    // ===== Cálculo 30/360
    function breakdown30_360(start, end, baja) {
      let y1 = start.getUTCFullYear(), m1 = start.getUTCMonth() + 1, d1 = start.getUTCDate();
      let y2 = end.getUTCFullYear(), m2 = end.getUTCMonth() + 1, d2 = end.getUTCDate();
      const s = Math.min(d1, 30), e = Math.min(d2, 30);
      const rows = [];
      if (y1 === y2 && m1 === m2) {
        let eEff; if (baja) { eEff = (d2 === 31 && is31MonthNum(m2)) ? 30 : e - 1; } else { eEff = e; }
        let days = eEff - s + 1; if (days < 1) days = 1; rows.push({ y: y1, m: m1, days }); return rows;
      }
      const daysFirst = 30 - s + 1; rows.push({ y: y1, m: m1, days: daysFirst });
      let yc = y1, mc = m1; while (true) { const nm = addMonth(yc, mc); yc = nm.y; mc = nm.m; if (yc === y2 && mc === m2) break; rows.push({ y: yc, m: mc, days: 30 }); }
      let last; if (baja) { last = (d2 === 31 && is31MonthNum(m2)) ? 30 : Math.max(0, e - 1); } else { last = e; } rows.push({ y: y2, m: m2, days: last });
      return rows;
    }

    // ===== Lógica de la interfaz y cálculos
    const ANTIG_Tabla = [{ y: 34, p: 170 }, { y: 32, p: 160 }, { y: 30, p: 150 }, { y: 28, p: 140 }, { y: 25, p: 130 }, { y: 24, p: 120 }, { y: 22, p: 110 }, { y: 20, p: 100 }, { y: 17, p: 80 }, { y: 15, p: 70 }, { y: 12, p: 60 }, { y: 10, p: 50 }, { y: 7, p: 40 }, { y: 5, p: 30 }, { y: 2, p: 15 }, { y: 1, p: 10 }, { y: 0, p: 0 }];
    function getAntiguedad(anios) { const item = ANTIG_Tabla.find(a => anios >= a.y); return item ? item.p : 0; }
    function uiUpdateAntigPct() {
      var el = document.getElementById('antiguedadPct');
      if (!el) return; var anios = parseInt(document.getElementById('antiguedadAnios').value || '0');
      var p = getAntiguedad(anios); el.textContent = p.toFixed(0) + '%';
    }
        function isHoras() {
      const t = (typeof getTipoCargo === 'function') ? getTipoCargo() : '';
      return t === 'HCNM' || t === 'HCNS';
    }
    function isMaestroGradoJornadaCompleta(cargo) { return cargo === "Maestro de Grado - Jornada Completa"; }

    const inputInicio = document.getElementById('inicio');
    const inputFin = document.getElementById('fin');
    const liqBlock = document.getElementById('liqBlock');
    const inputSuplente = document.getElementById('suplente');
    const inputBaja = document.getElementById('baja');
    const complementoBox = document.getElementById('complementoBox');

    const liqDato = {
      diasLiq: document.getElementById('diasLiq'),
      a01: document.getElementById('a01Importe'),
      a03: document.getElementById('a03Importe'),
      a04: document.getElementById('a04Importe'),
      totalParcial: document.getElementById('totalParcial'),
      diasExc: document.getElementById('diasExc'),
      a01Exc: document.getElementById('a01Exc'),
      a03Exc: document.getElementById('a03Exc'),
      a04Exc: document.getElementById('a04Exc')
    };
    const inputIndiceMes = document.getElementById('indiceMes');
    const inputIndiceMesPrev = document.getElementById('indiceMesPrev');
    const inputAntiguedad = document.getElementById('antiguedadAnios');
    const selectRadio = document.getElementById('radioDocente');
    const tbodyMeses = document.getElementById('tbodyMeses');
    const totalDias = document.getElementById('totalDias');
    const periodoLabel = document.getElementById('periodoLabel');
    const selectAnioSAC = document.getElementById('anioSAC');
    const selectSemSAC = document.getElementById('semSAC');
    const diasSAC = document.getElementById('diasSAC');
    const decimasBlock = document.getElementById('decimasBlock');
    const decimasTotal = document.getElementById('decimasTotal');
    const decimasDetalle = document.getElementById('decimasDetalle');
    const finLabel2 = document.getElementById('finLabel2');

    // Inicializar años para SAC
    const currentYear = new Date().getFullYear();
    for (let i = currentYear - 5; i <= currentYear + 1; i++) {
      const opt = document.createElement('option');
      opt.value = i; opt.textContent = i;
      selectAnioSAC.appendChild(opt);
    }
    selectAnioSAC.value = currentYear;

    function renderDesglose(rows) {
      tbodyMeses.innerHTML = '';
      if (rows.length === 0) {
        tbodyMeses.innerHTML = '<tr><td class="muted" colspan="2">Ingresá inicio y fin…</td></tr>';
        totalDias.textContent = '0';
        return;
      }
      let total = 0;
      rows.forEach(r => {
        const tr = document.createElement('tr');
        const td1 = document.createElement('td');
        const td2 = document.createElement('td');
        td1.textContent = `${monthNameEs(r.m)} ${r.y}`;
        td2.textContent = r.days;
        tr.appendChild(td1);
        tr.appendChild(td2);
        tbodyMeses.appendChild(tr);
        total += r.days;
      });
      totalDias.textContent = total;
    }

    function calcularSAC(rows, anio, sem) {
      let dias = 0;
      const startMonth = (sem === 1) ? 1 : 7;
      const endMonth = (sem === 1) ? 6 : 12;
      rows.forEach(r => {
        if (r.y === anio && r.m >= startMonth && r.m <= endMonth) {
          dias += r.days;
        }
      });
      return dias;
    }

    function calcularDecimas(rows) {
      let diasTotal = 0;
      const detalle = [];
      const startMonth = 3, endMonth = 12; // Marzo a Diciembre
      rows.forEach(r => {
        if (r.m >= startMonth && r.m <= endMonth) {
          diasTotal += r.days;
          detalle.push(`${monthNameEs(r.m)} ${r.y}: ${r.days} días`);
        }
      });
      return { total: diasTotal, detalle: detalle.join(' · ') };
    }

            function calculateLiq(start, end, baja) {
      if (!start || !end) {
        liqDato.diasLiq.textContent = '0';
        liqBlock.style.display = 'none';
        complementoBox.style.display = 'none';
        return;
      }
      liqBlock.style.display = 'block';
      const tipoSel = (typeof getTipoCargo === 'function') ? (getTipoCargo() || '') : '';
      const esHoras = isHoras();
      const horasSeleccionadas = esHoras ? Number((typeof getHorasSeleccionadas === 'function' ? getHorasSeleccionadas() : 0) || 0) : 0;
      const categoriaId = esHoras ? 0 : Number((typeof getCategoriaId === 'function' ? getCategoriaId() : 0) || 0);

      // TODO (siguiente paso): cuando integremos el JSON, de acá vamos a traer {A01,A32,A44,total_puntos}
      let puntos = 0; // se reemplaza con total_puntos del cargo seleccionado

      const indice = parseFloat(inputIndiceMes.value) || 0;
      const indicePrev = parseFloat(inputIndiceMesPrev.value) || 0;
      const antiguedadAnios = parseFloat(inputAntiguedad.value) || 0;
      const radioPorcentaje = parseFloat(selectRadio.value) || 0;
      const antiguedadPts = getAntiguedad(antiguedadAnios);
      // Recalcular por 30/360 respetando BAJA
      const rowsCalc = breakdown30_360(start, end, baja);
      let totalDays = 0; rowsCalc.forEach(r => totalDays += r.days);
      let diasBase = Math.min(30, totalDays);
      let diasExc = Math.max(0, totalDays - 30);
      complementoBox.style.display = (diasExc > 0) ? 'block' : 'none';
      const mesBaseName = monthNameEs(end.getUTCMonth() + 1);
      liqDato.diasLiq.textContent = `${diasBase} Días - ${mesBaseName} ${end.getUTCFullYear()}`;
      liqDato.diasExc.textContent = diasExc;
      const sueldoBasico = esHoras ? (horasSeleccionadas * 15 * indice) : (puntos * indice);
      const a01 = (sueldoBasico / 30) * diasBase;
      const a03 = (sueldoBasico * (antiguedadPts / 100)) / 30 * diasBase;
      const a04 = (sueldoBasico * (radioPorcentaje / 100)) / 30 * diasBase;
      let totalParcial = a01 + a03 + a04;

      const sueldoBasicoExc = esHoras ? (horasSeleccionadas * 15 * indicePrev) : (puntos * indicePrev);
      const a01Exc = (sueldoBasicoExc / 30) * diasExc;
      const a03Exc = (sueldoBasicoExc * (antiguedadPts / 100)) / 30 * diasExc;
      const a04Exc = (sueldoBasicoExc * (radioPorcentaje / 100)) / 30 * diasExc;

      liqDato.a01.textContent = fmtAR(a01);
      liqDato.a03.textContent = fmtAR(a03);
      liqDato.a04.textContent = fmtAR(a04);
      liqDato.a01Exc.textContent = fmtAR(a01Exc);
      liqDato.a03Exc.textContent = fmtAR(a03Exc);
      liqDato.a04Exc.textContent = fmtAR(a04Exc);

      let e66Base = 0, e66Exc = 0;
      let e60Base = 0, e60Exc = 0;

      /* === E66 (30d escalado por índice) + F66 (excedente mes anterior) === */
      function updateComplementoRow(code, visible, valor) {
        const row = document.getElementById('row' + code);
        const cellId = code === 'F66' ? 'f66Importe' : 'f60Importe';
        const cell = document.getElementById(cellId);
        if (row) row.style.display = visible ? 'table-row' : 'none';
        if (cell) {
          const value = visible ? Number(valor || 0) : 0;
          cell.textContent = fmtAR(value);
        }
      }

      (async function calcE66(){
        const chk = document.getElementById('optE66');
        const rowE = document.getElementById('rowE66');
        const outE = document.getElementById('e66Importe');

        const usar = chk?.checked === true;
        const ymSel = document.getElementById('indicePeriodo')?.value
                   || document.getElementById('indiceMes')?.value
                   || '';

        let tipo = tipoSel || 'CARGOS';
        let horas = esHoras ? (horasSeleccionadas > 0 ? horasSeleccionadas : 1) : 1;
        const antigAnios = antiguedadAnios;

        if (rowE) rowE.style.display = usar ? 'table-row' : 'none';

        const resetOutputs = () => {
          if (outE) outE.textContent = '0,00';
          updateComplementoRow('F66', false);
        };

        if (!usar || !ymSel || !window.CODIGOS?.E66) {
          resetOutputs();
          return;
        }

        try {
          const base = await window.CODIGOS.E66.getImporte({
            ym: ymSel, tipo, horas, dias: Number(diasBase || 0), antigAnios
          });
          const exc = await window.CODIGOS.E66.getImportePrev({
            ym: ymSel, tipo, horas, dias: Number(diasExc || 0), antigAnios
          });

          if (outE) outE.textContent = (base || 0).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          // Solo Complemento para F66:
          updateComplementoRow('F66', usar && (Number(diasExc || 0) > 0), exc);

          if (typeof totalParcial === 'number') {
            totalParcial += Number(base || 0);
            liqDato.totalParcial.textContent = fmtAR(totalParcial);
          }
        } catch (err) {
          console.warn('E66 calc error:', err);
          resetOutputs();
        }
      })();

      /* === E60 base (30 días) + F60 complemento (índice mes anterior) === */
      (function calcE60() {
        const chk = document.getElementById('optE60');
        const outBase = document.getElementById('e60Importe');
        const rowE60 = document.getElementById('rowE60');
        if (!chk || !outBase) return;

        const esCargo = !esHoras;
        const diasBaseCalc = Number(diasBase) || 0;
        const diasExcCalc  = Number(diasExc) || 0;

        const usarE60 = chk.checked && esCargo && window.CODIGOS?.E60;

        if (usarE60) {
          e60Base = window.CODIGOS.E60.getImporteBase({
            dias: diasBaseCalc,
            antigAnios: antiguedadAnios,
            indiceActual: indice
          }) || 0;

          e60Exc = window.CODIGOS.E60.getImporteComplemento({
            dias: diasExcCalc,
            antigAnios: antiguedadAnios,
            indiceAnterior: indicePrev
          }) || 0;
        } else {
          e60Base = 0;
          e60Exc = 0;
        }

        if (outBase) outBase.textContent = (e60Base || 0).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        if (rowE60) rowE60.style.display = (chk.checked && esCargo) ? 'table-row' : 'none';
        // Solo Complemento para F60:
        updateComplementoRow('F60', usarE60 && (Number(diasExc) > 0), e60Exc);

        if (usarE60) {
          totalParcial += Number(e60Base || 0);
        }
      })();

      liqDato.totalParcial.textContent = fmtAR(totalParcial);
    }
    function update() {
      const start = parseDate(inputInicio.value);
      const end = parseDate(inputFin.value);
      const baja = inputBaja.checked;
      const suplente = inputSuplente.checked;

      if (baja) { finLabel2.textContent = 'INCLUIDO'; } else { finLabel2.textContent = 'NO incluido'; }

      if (!start || !end || end < start) {
        periodoLabel.textContent = '—';
        renderDesglose([]);
        diasSAC.textContent = '—';
        decimasBlock.style.display = 'none';
        calculateLiq(null, null, baja);
        return;
      }

      periodoLabel.textContent = `${fmtDMY(start)} al ${fmtDMY(end)}`;
      const rows = breakdown30_360(start, end, baja);
      renderDesglose(rows);

      const sacAnio = parseInt(selectAnioSAC.value);
      const sacSem = parseInt(selectSemSAC.value);
      const diasSemestre = calcularSAC(rows, sacAnio, sacSem);
      diasSAC.textContent = diasSemestre;

      const decimasData = calcularDecimas(rows);
      decimasTotal.textContent = decimasData.total;
      decimasDetalle.textContent = decimasData.detalle || '—';
      decimasBlock.style.display = (baja && suplente && decimasData.total > 0) ? 'block' : 'none';


      calculateLiq(start, end, baja);
    }

    // Event Listeners
    inputInicio.addEventListener('change', update);
    inputFin.addEventListener('change', update);
    inputBaja.addEventListener('change', update);
    inputBaja.addEventListener('input', update);
    inputIndiceMes.addEventListener('input', update);
    inputIndiceMesPrev.addEventListener('input', update);
    inputAntiguedad.addEventListener('input', function () { uiUpdateAntigPct(); update(); });
    selectRadio.addEventListener('change', update);
    selectAnioSAC.addEventListener('change', update);
    selectSemSAC.addEventListener('change', update);
    // Initial call to set up the UI correctly
    uiUpdateAntigPct();
    update();
  </script>
  <script>
    (function () {
      const orig = document.getElementById('indiceMesPrev');
      const clone = document.getElementById('indiceMesPrev_clone');
      if (!orig || !clone) return;

      // Keep values in sync both ways
      const sync = (from, to) => { to.value = from.value; };
      orig.addEventListener('input', () => sync(orig, clone));
      clone.addEventListener('input', () => sync(clone, orig));
      // initialize
      sync(orig, clone);

      function updateToolbarVisibility() {
        // read excedente days from the pill element inside complementoBox
        const pill = document.querySelector('#complementoBox .pill');
        let exced = 0;
        if (pill) {
          const match = pill.textContent.match(/(\d+)/);
          if (match) exced = parseInt(match[1], 10);
        }
        document.getElementById('indicePrevToolbar').style.display = exced > 0 ? 'flex' : 'none';
      }

      // Observe mutations in complementoBox to catch updates to the pill
      const target = document.getElementById('complementoBox');
      const mo = new MutationObserver(updateToolbarVisibility);
      mo.observe(target, { childList: true, subtree: true, characterData: true });

      // Also run on load and when dates/inputs change
      updateToolbarVisibility();
      ['fechaInicio', 'fechaFin', 'bajaCheck', 'indiceMes', 'radioDocente', 'antiguedadAnios'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updateToolbarVisibility);
        if (el) el.addEventListener('change', updateToolbarVisibility);
      });
    })();
  </script>
  <script>
    // === Extras visibility controller (immediate + DOMContentLoaded) ===
    (function () {
      function $(id) { return document.getElementById(id); }
      const chkSuplente = $('suplente');
      const optA56 = $('optA56');
      const optE66 = $('optE66');
      const optE60 = $('optE60');

      function ensureExtraRows() {
        let tbody = document.getElementById('a04Importe')?.closest('tbody') || document.getElementById('liqBaseBody');
        if (!tbody) return;
        function mkRow(id, code, title) {
          if (document.getElementById(id)) return;
          const tr = document.createElement('tr'); tr.id = id; tr.style.display = 'none';
          const td1 = document.createElement('td'); td1.title = title; td1.innerHTML = '<b>' + code + '</b>';
          const td2 = document.createElement('td'); td2.textContent = '$';
          const td3 = document.createElement('td'); td3.id = id.replace('row', '').toLowerCase() + 'Importe'; td3.textContent = '0,00';
          tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
          // insert right after A04 row if exists, else append
          const a04 = document.getElementById('a04Importe')?.parentElement;
          if (a04) { a04.insertAdjacentElement('afterend', tr); } else if (tbody) { tbody.appendChild(tr); }
        }
        mkRow('rowA56', 'A56', 'Estado Docente');
        mkRow('rowE29', 'E29', 'Equipamiento Suplentes');
        mkRow('rowE66', 'E66', 'Suma Remunerativa y bonificable por antigüedad');
        mkRow('rowE60', 'E60', 'Suma Remunerativa y bonificable por antigüedad (solo cargos)');
      }

      const rowA56 = $('rowA56');
      const rowE29 = $('rowE29');
      const rowE66 = $('rowE66');
      const rowE60 = $('rowE60');

      function isCargoSeleccionado() {
        const tipo = (typeof getTipoCargo === 'function') ? getTipoCargo() : '';
        return tipo !== 'HCNM' && tipo !== 'HCNS';
      }

      function refreshExtrasVisibility() {
        ensureExtraRows();
        const esCargo = isCargoSeleccionado();
        if (rowA56) rowA56.style.display = (optA56 && optA56.checked) ? 'table-row' : 'none';
        if (rowE66) rowE66.style.display = (optE66 && optE66.checked) ? 'table-row' : 'none';
        if (rowE60) rowE60.style.display = (optE60 && optE60.checked && esCargo) ? 'table-row' : 'none';
        if (rowE29) rowE29.style.display = (chkSuplente && chkSuplente.checked && esCargo) ? 'table-row' : 'none';
      }

      function bind(el, ev) { if (el) el.addEventListener(ev, function () { refreshExtrasVisibility(); if (typeof update === 'function') update(); }); }

      function __extrasInit() {
        ensureExtraRows();
        refreshExtrasVisibility();
        // Bind changes
        ['tipoSeleccion', 'catId', 'horasHCNM', 'horasHCNS', 'baja', 'suplente',
          'optA56', 'optE66', 'optE60', 'radioDocente', 'antiguedadAnios', 'indiceMes', 'indiceMesPrev']
          .forEach(id => { const el = $(id); if (el) { bind(el, 'change'); bind(el, 'input'); } });
      }

      // Run immediately if DOM is already ready; otherwise bind to DOMContentLoaded
      if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', __extrasInit); } else { __extrasInit(); if (typeof update === 'function') update(); }

      // Also observe the base table for updates that might rewrite DOM
      const target = $('liqBlock');
      if (target && 'MutationObserver' in window) {
        const mo = new MutationObserver(() => refreshExtrasVisibility());
        mo.observe(target, { childList: true, subtree: true });
        // short-lived enforcement in case of late DOM updates
        let __count = 0; const __iv = setInterval(() => { try { refreshExtrasVisibility(); } catch (e) { } if (++__count > 10) clearInterval(__iv); }, 200);
      }
    })();
  </script>
  <script>
  document.getElementById('optE66')?.addEventListener('change', () => {
    const on = document.getElementById('optE66').checked;
    // E66 (columna base)
    document.getElementById('rowE66')?.style.setProperty('display', on ? '' : 'none');
    // F66 (columna complemento) se recalcula y decide su visibilidad en calcE66()
    document.getElementById('rowF66')?.style.setProperty('display', 'none');
    // Recalcular todo
    if (typeof update === 'function') update();
  });
</script>
  <script>
  /* Antigüedad: solo input numérico; limpiar restos y mantener look unificado */
  (function () {
    // Limpiar posibles restos/fantasmas
    document.querySelectorAll('#antiguedadSelect, #antiguedadPeriodo, #antiguedadOptions, .antiguedad-ghost')
      .forEach(node => node.remove());

    const input = document.getElementById('antiguedadAnios');
    if (!input) return;
    // Atributos mínimos del control (no tocar estructura HTML)
    try {
      input.setAttribute('type', 'number');
      if (!input.hasAttribute('min'))  input.setAttribute('min', '0'); else input.min = '0';
      if (!input.hasAttribute('max'))  input.setAttribute('max', '40'); else input.max = '40';
      if (!input.hasAttribute('step')) input.setAttribute('step', '1'); else input.step = '1';
    } catch (e) { /* noop */ }

    // Asegurar tipeo libre con límites razonables (0..40). Ajustar si tu lógica cambia.
    const clamp = n => Math.max(0, Math.min(40, Number(n) || 0));
    input.addEventListener('input', () => {
      const n = clamp(input.value);
      if (String(n) !== String(input.value)) input.value = String(n);
      input.dispatchEvent(new Event('input', { bubbles:true }));
      if (typeof update === 'function') { try { update(); } catch {} }
    });
  })();
  const input = document.getElementById('antiguedadAnios');

const clamp = (n, min, max) => Math.min(max, Math.max(min, n));
const digitCount = v => String(Math.trunc(Math.abs(Number(v)) || 0)).length;

function ajustarAncho() {
  const needed = clamp(digitCount(input.value) + 1, 4, 10);
  input.style.width = `${needed}ch`;
}

ajustarAncho();
input.addEventListener('input', ajustarAncho);
input.addEventListener('change', ajustarAncho);

  </script>

  <script>
  /* === Nuevo controlador del menú Cargos/Horas === */
  (function(){
    const sel = document.getElementById('tipoSeleccion');
    const pCargos = document.getElementById('panelCargos');
    const pHCNM  = document.getElementById('panelHCNM');
    const pHCNS  = document.getElementById('panelHCNS');
    const catId  = document.getElementById('catId');
    const horasM = document.getElementById('horasHCNM');
    const horasS = document.getElementById('horasHCNS');

    function show(panel){
      if (pCargos) pCargos.style.display = (panel === 'CARGOS') ? 'block' : 'none';
      if (pHCNM)  pHCNM.style.display   = (panel === 'HCNM')   ? 'block' : 'none';
      if (pHCNS)  pHCNS.style.display   = (panel === 'HCNS')   ? 'block' : 'none';
    }

    sel?.addEventListener('change', () => {
      show(sel.value || '');
      if (typeof update === 'function') { try { update(); } catch {} }
    });

    [catId, horasM, horasS].forEach(el => {
      if (!el) return;
      el.addEventListener('input', () => { if (typeof update === 'function') { try { update(); } catch {} } });
    });

    // === Helpers globales que usa el resto de la app ===
    window.getTipoCargo = function(){
      // Devuelve 'CARGOS' | 'HCNM' | 'HCNS' | '' según selección
      return sel?.value || '';
    };
    window.getHorasSeleccionadas = function(){
      // Según tipo, devuelve número de horas o 0
      const t = window.getTipoCargo();
      if (t === 'HCNM') return Number(horasM?.value || 0);
      if (t === 'HCNS') return Number(horasS?.value || 0);
      return 0;
    };
    window.getCategoriaId = function(){
      // Solo para CARGOS; devuelve la categoría ingresada (ID del cargo)
      const t = window.getTipoCargo();
      if (t === 'CARGOS') return Number(catId?.value || 0);
      return 0;
    };

    // Estado inicial
    show(sel?.value || '');
  })();
  </script>
  </body>

</html>


